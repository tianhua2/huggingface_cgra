# ุงูุชุฏุฑูุจ ุงููุนุงู ุนูู ูุญุฏุงุช ูุนุงูุฌุฉ ุงูุฑุณููุงุช (GPUs) ูุชุนุฏุฏุฉ

ุฅุฐุง ูุงู ุชุฏุฑูุจ ูููุฐุฌ ุนูู ูุญุฏุฉ ูุนุงูุฌุฉ ุฑุณููุงุช (GPU) ูุงุญุฏุฉ ุจุทูุฆูุง ุฌุฏูุง ุฃู ุฅุฐุง ูู ุชุชุณุน ุฐุงูุฑุฉ ูุญุฏุฉ ุงููุนุงูุฌุฉ ุงูุฑุณูููุฉ ููุฒู ุงููููุฐุฌุ ููุฏ ูููู ุงูุงูุชูุงู ุฅูู ุฅุนุฏุงุฏ ูุชุนุฏุฏ ูุญุฏุงุช ูุนุงูุฌุฉ ุงูุฑุณููุงุช ุฎูุงุฑูุง ูุงุจููุง ููุชุทุจูู. ูุจู ุฅุฌุฑุงุก ูุฐุง ุงูุงูุชูุงูุ ูู ุจุงุณุชูุดุงู ุฌููุน ุงูุงุณุชุฑุงุชูุฌูุงุช ุงููุดูููุฉ ูู "ุฃุณุงููุจ ูุฃุฏูุงุช ุงูุชุฏุฑูุจ ุงููุนุงู ุนูู ูุญุฏุฉ ูุนุงูุฌุฉ ุฑุณููุงุช ูุงุญุฏุฉ" ุจุดูู ุดุงููุ ุญูุซ ุฃููุง ุชูุทุจู ุนุงููููุง ุนูู ุชุฏุฑูุจ ุงูููุงุฐุฌ ุนูู ุฃู ุนุฏุฏ ูู ูุญุฏุงุช ูุนุงูุฌุฉ ุงูุฑุณููุงุช. ุจูุฌุฑุฏ ุงุณุชุฎุฏุงูู ููุฐู ุงูุงุณุชุฑุงุชูุฌูุงุช ููุฌุฏุช ุฃููุง ุบูุฑ ูุงููุฉ ูุญุงูุชู ุนูู ูุญุฏุฉ ูุนุงูุฌุฉ ุฑุณููุงุช ูุงุญุฏุฉุ ููุฑ ูู ุงูุงูุชูุงู ุฅูู ูุญุฏุงุช ูุนุงูุฌุฉ ุงูุฑุณููุงุช ุงููุชุนุฏุฏุฉ.

ูุชุทูุจ ุงูุงูุชูุงู ูู ูุญุฏุฉ ูุนุงูุฌุฉ ุฑุณููุงุช ูุงุญุฏุฉ ุฅูู ูุญุฏุงุช ูุนุงูุฌุฉ ุงูุฑุณููุงุช ุงููุชุนุฏุฏุฉ ุชูุฏูู ุจุนุถ ุฃุดูุงู ุงูุชูุงุฒูุ ุญูุซ ูุฌุจ ุชูุฒูุน ุนุจุก ุงูุนูู ุนุจุฑ ุงูููุงุฑุฏ. ูููู ุงุณุชุฎุฏุงู ุชูููุงุช ูุชุนุฏุฏุฉ ูุชุญููู ุงูุชูุงุฒูุ ูุซู ุงูุชูุงุฒู ูู ุงูุจูุงูุงุชุ ูุงูุชูุงุฒู ูู ุงููุตูููุงุชุ ูุงูุชูุงุฒู ูู ุงูุฃูุงุจูุจ. ููู ุงูููู ููุงุญุธุฉ ุฃูู ูุง ููุฌุฏ ุญู ูุงุญุฏ ููุงุณุจ ุงูุฌููุนุ ูุฃู ุงูุฅุนุฏุงุฏุงุช ุงููุซุงููุฉ ุชุนุชูุฏ ุนูู ุชูููู ุงูุฃุฌูุฒุฉ ุงููุญุฏุฏ ุงูุฐู ุชุณุชุฎุฏูู.

ููุฏู ูุฐุง ุงูุฏููู ูุธุฑุฉ ูุชุนููุฉ ุนูู ุฃููุงุน ูุฑุฏูุฉ ูู ุงูุชูุงุฒูุ ุจุงูุฅุถุงูุฉ ุฅูู ุชูุฌููุงุช ุญูู ุทุฑู ุงูุฌูุน ุจูู ุงูุชูููุงุช ูุงุฎุชูุงุฑ ุงูููุฌ ุงูููุงุณุจ. ููุญุตูู ุนูู ุฏุฑูุณ ุฎุทูุฉ ุจุฎุทูุฉ ุญูู ุงูุชุฏุฑูุจ ุงูููุฒุนุ ูุฑุฌู ุงูุฑุฌูุน ุฅูู ูุซุงุฆู ๐ค Accelerate.

ุนูู ุงูุฑุบู ูู ุฃู ุงูููุงููู ุงูุฑุฆูุณูุฉ ุงูุชู ุชูุช ููุงูุดุชูุง ูู ูุฐุง ุงูุฏููู ุชูุทุจู ุนูู ุงูุฃุทุฑ ุงููุฎุชููุฉุ ุฅูุง ุฃููุง ูุฑูุฒ ููุง ุนูู ุนูููุงุช ุงูุชูููุฐ ุงููุณุชูุฏุฉ ุฅูู PyTorch.

ูุจู ุงูุบูุต ูู ุชูุงุตูู ูู ุชูููุฉุ ุฏุนูุง ูููู ูุธุฑุฉ ุนูู ุนูููุฉ ุงุชุฎุงุฐ ุงููุฑุงุฑ ุนูุฏ ุชุฏุฑูุจ ููุงุฐุฌ ูุจูุฑุฉ ุนูู ุจููุฉ ุชุญุชูุฉ ูุจูุฑุฉ.

## ุงุณุชุฑุงุชูุฌูุฉ ูุงุจููุฉ ุงูุชูุณุน

ุงุจุฏุฃ ุจุชูุฏูุฑ ููุฏุงุฑ ุฐุงูุฑุฉ ุงููุตูู ุงูุนุดูุงุฆู ุงูุธุงูุฑู (vRAM) ุงููุทููุจุฉ ูุชุฏุฑูุจ ูููุฐุฌู. ุจุงููุณุจุฉ ููููุงุฐุฌ ุงููุณุชุถุงูุฉ ุนูู ๐ค Hubุ ุงุณุชุฎุฏู "ุญุงุณุจุฉ ุฐุงูุฑุฉ ุงููููุฐุฌ" ุงูุฎุงุตุฉ ุจูุงุ ูุงูุชู ุชููุฑ ูู ุญุณุงุจุงุช ุฏูููุฉ ุถูู ูุงูุด ุจูุณุจุฉ 5%.

**ุงุณุชุฑุงุชูุฌูุฉ ุงูููุงุฒุงุฉ ูุนูุฏุฉ ูุงุญุฏุฉ / ุฅุนุฏุงุฏ ูุชุนุฏุฏ ูุญุฏุงุช ูุนุงูุฌุฉ ุงูุฑุณููุงุช**

ุนูุฏ ุชุฏุฑูุจ ูููุฐุฌ ุนูู ุนูุฏุฉ ูุงุญุฏุฉ ูุน ูุญุฏุงุช ูุนุงูุฌุฉ ุงูุฑุณููุงุช ุงููุชุนุฏุฏุฉุ ูููู ุฃู ูุคุซุฑ ุงุฎุชูุงุฑู ูุงุณุชุฑุงุชูุฌูุฉ ุงูููุงุฒุงุฉ ุจุดูู ูุจูุฑ ุนูู ุงูุฃุฏุงุก. ูููุง ููู ุชูุตูู ูุฎูุงุฑุงุชู:

**ุงูุญุงูุฉ 1: ููุงุณุจ ูููุฐุฌู ูุญุฏุฉ ูุนุงูุฌุฉ ุฑุณููุงุช ูุงุญุฏุฉ**

ุฅุฐุง ูุงู ูููุฐุฌู ููุงุณุจ ูุญุฏุฉ ูุนุงูุฌุฉ ุงูุฑุณููุงุช ุงููุงุญุฏุฉ ุจุดูู ูุฑูุญุ ูููุงู ุฎูุงุฑุงู ุฑุฆูุณูุงู:

1. DDP - Distributed DataParallel
2. Zero Redundancy Optimizer (ZeRO) - ุงุนุชูุงุฏูุง ุนูู ุงููุถุน ูุงูุชูููู ุงููุณุชุฎุฏูุ ูุฏ ุชููู ูุฐู ุงูุทุฑููุฉ ุฃุณุฑุน ุฃู ูุงุ ูููู ูู ุงูุฌุฏูุฑ ุชุฌุฑุจุชูุง.

**ุงูุญุงูุฉ 2: ูุง ููุงุณุจ ูููุฐุฌู ูุญุฏุฉ ูุนุงูุฌุฉ ุฑุณููุงุช ูุงุญุฏุฉ**

ุฅุฐุง ูุงู ูููุฐุฌู ุฃูุจุฑ ูู ูุญุฏุฉ ูุนุงูุฌุฉ ุงูุฑุณููุงุช ุงููุงุญุฏุฉุ ูููุงู ุงูุนุฏูุฏ ูู ุงูุจุฏุงุฆู ุงูุชู ูุฌุจ ูุฑุงุนุงุชูุง:

1. PipelineParallel (PP)
2. ZeRO
3. TensorParallel (TP)

ูุน ุงุชุตุงู ุณุฑูุน ุจูู ุงูุนูุฏ (ูุซู NVLINK ุฃู NVSwitch)ุ ูุฌุจ ุฃู ุชุคุฏู ุฌููุน ุงูุงุณุชุฑุงุชูุฌูุงุช ุงูุซูุงุซ (PP ูZeRO ูTP) ุฅูู ุฃุฏุงุก ููุงุซู. ููุน ุฐููุ ุจุฏูู ูุฐู ุงูููุฒุงุชุ ุณูููู PP ุฃุณุฑุน ูู TP ุฃู ZeRO. ูุฏ ููุญุฏุซ ุฃูุถูุง ุฏุฑุฌุฉ TP ูุฑููุง. ูู ุงูุฃูุถู ุชุฌุฑุจุฉ ุฅุนุฏุงุฏู ุงููุญุฏุฏ ูุชุญุฏูุฏ ุงูุงุณุชุฑุงุชูุฌูุฉ ุงูุฃูุณุจ.

ูุชู ุงุณุชุฎุฏุงู TP ุฏุงุฆููุง ุชูุฑูุจูุง ุฏุงุฎู ุนูุฏุฉ ูุงุญุฏุฉ. ููุฐุง ูุนูู ุฃู ุญุฌู TP ูุณุงูู ุฃู ุฃูู ูู ูุญุฏุงุช ูุนุงูุฌุฉ ุงูุฑุณููุงุช ููู ุนูุฏุฉ.

**ุงูุญุงูุฉ 3: ูุง ุชูุงุณุจ ุงูุทุจูุฉ ุงูุฃูุจุฑ ูู ูููุฐุฌู ูุญุฏุฉ ูุนุงูุฌุฉ ุฑุณููุงุช ูุงุญุฏุฉ**

1. ุฅุฐุง ููุช ูุง ุชุณุชุฎุฏู ZeROุ ููุฌุจ ุนููู ุงุณุชุฎุฏุงู TensorParallel (TP)ุ ูุฃู PipelineParallel (PP) ูุญุฏูุง ูู ุชููู ูุงููุฉ ูุงุณุชูุนุงุจ ุงูุทุจูุฉ ุงููุจูุฑุฉ.
2. ุฅุฐุง ููุช ุชุณุชุฎุฏู ZeROุ ูุงุนุชูุฏ ุฃูุถูุง ุชูููุงุช ูู "ุฃุณุงููุจ ูุฃุฏูุงุช ุงูุชุฏุฑูุจ ุงููุนุงู ุนูู ูุญุฏุฉ ูุนุงูุฌุฉ ุฑุณููุงุช ูุงุญุฏุฉ".

**ุงุณุชุฑุงุชูุฌูุฉ ุงูููุงุฒุงุฉ ูุนูุฏุฉ ูุชุนุฏุฏุฉ / ุฅุนุฏุงุฏ ูุชุนุฏุฏ ูุญุฏุงุช ูุนุงูุฌุฉ ุงูุฑุณููุงุช**

* ุนูุฏ ูุฌูุฏ ุงุชุตุงู ุณุฑูุน ุจูู ุงูุนูุฏ (ูุซู NVLINK ุฃู NVSwitch)ุ ููุฑ ูู ุงุณุชุฎุฏุงู ุฃุญุฏ ุงูุฎูุงุฑุงุช ุงูุชุงููุฉ:

    1. ZeRO - ูุฃูู ูุชุทูุจ ุฅุฌุฑุงุก ุชุนุฏููุงุช ุทูููุฉ ุนูู ุงููููุฐุฌ ุชูุฑูุจูุง
    2. ูุฒูุฌ ูู PipelineParallel (PP) ูุน TensorParallel (TP) ูDataParallel (DP) - ุณูุคุฏู ูุฐุง ุงูููุฌ ุฅูู ุชูููู ุงูุงุชุตุงูุงุชุ ููููู ูุชุทูุจ ุฅุฌุฑุงุก ุชุบููุฑุงุช ูุจูุฑุฉ ุนูู ุงููููุฐุฌ

* ุนูุฏ ูุฌูุฏ ุงุชุตุงู ุจุทูุก ุจูู ุงูุนูุฏ ููุง ุชุฒุงู ุฐุงูุฑุฉ ูุญุฏุฉ ูุนุงูุฌุฉ ุงูุฑุณููุงุช ููุฎูุถุฉ:

    1. ุงุณุชุฎุฏู ูุฒูุฌูุง ูู DataParallel (DP) ูุน PipelineParallel (PP) ูTensorParallel (TP) ูZeRO.

ูู ุงูุฃูุณุงู ุงูุชุงููุฉ ูู ูุฐุง ุงูุฏูููุ ุณูุบูุต ุจุดูู ุฃุนูู ูู ููููุฉ ุนูู ุฃุณุงููุจ ุงูุชูุงุฒู ุงููุฎุชููุฉ ูุฐู.

## ุงูุชูุงุฒู ูู ุงูุจูุงูุงุช

ุญุชู ูุน ูุฌูุฏ ูุญุฏุชู ูุนุงูุฌุฉ ุฑุณููุงุช ููุทุ ููููู ุงูุงุณุชูุงุฏุฉ ุจุณูููุฉ ูู ูุฏุฑุงุช ุงูุชุฏุฑูุจ ุงููุนุฌูุฉ ุงูุชู ุชููุฑูุง ููุฒุงุช PyTorch ุงููุฏูุฌุฉุ ูุซู `DataParallel` (DP) ู`DistributedDataParallel` (DDP). ูุงุญุธ ุฃู ูุซุงุฆู PyTorch ุชูุตู ุจุงุณุชุฎุฏุงู `DistributedDataParallel` (DDP) ุจุฏูุงู ูู `DataParallel` (DP) ููุชุฏุฑูุจ ุนูู ูุญุฏุงุช ูุนุงูุฌุฉ ุงูุฑุณููุงุช ุงููุชุนุฏุฏุฉ ูุฃูู ูุนูู ูุน ุฌููุน ุงูููุงุฐุฌ. ุฏุนููุง ูููู ูุธุฑุฉ ุนูู ููููุฉ ุนูู ูุงุชูู ุงูุทุฑููุชูู ููุง ุงูุฐู ูููุฒููุง.

### DataParallel ููุงุจู DistributedDataParallel

ูููู ุงูุงุฎุชูุงูุงุช ุงูุฑุฆูุณูุฉ ูู ุนุจุก ุงูุงุชุตุงู ุจูู ูุญุฏุงุช ูุนุงูุฌุฉ ุงูุฑุณููุงุช ุจูู ุงูุทุฑููุชููุ ุฏุนูุง ูุฑุงุฌุน ุงูุนูููุงุช ููู ุฏูุนุฉ:

[DDP]:

- ูู ููุช ุงูุจุฏุกุ ุชููู ุงูุนูููุฉ ุงูุฑุฆูุณูุฉ ุจูุณุฎ ุงููููุฐุฌ ูุฑุฉ ูุงุญุฏุฉ ูู ูุญุฏุฉ ูุนุงูุฌุฉ ุงูุฑุณููุงุช 0 ุฅูู ุจุงูู ูุญุฏุงุช ูุนุงูุฌุฉ ุงูุฑุณููุงุช
- ุจุนุฏ ุฐูู ููู ุฏูุนุฉ:
    1. ุชุณุชููู ูู ูุญุฏุฉ ูุนุงูุฌุฉ ุฑุณููุงุช ูุจุงุดุฑุฉ ุฏูุนุฉ ุงูุจูุงูุงุช ุงููุตุบุฑุฉ ุงูุฎุงุตุฉ ุจูุง.
    2. ุฃุซูุงุก `backward`ุ ุจูุฌุฑุฏ ุฃู ุชุตุจุญ ุงูุชุฏุฑุฌุงุช ุงููุญููุฉ ุฌุงูุฒุฉุ ูุชู ุญุณุงุจ ูุชูุณุทูุง ุนุจุฑ ุฌููุน ุงูุนูููุงุช.

[DP]:

ููู ุฏูุนุฉ:
    1. ุชูุฑุฃ ูุญุฏุฉ ูุนุงูุฌุฉ ุงูุฑุณููุงุช 0 ุฏูุนุฉ ุงูุจูุงูุงุช ูุชุฑุณู ุฏูุนุฉ ูุตุบุฑุฉ ุฅูู ูู ูุญุฏุฉ ูุนุงูุฌุฉ ุฑุณููุงุช.
    2. ูุชู ูุณุฎ ุงููููุฐุฌ ุงููุญุฏุซ ูู ูุญุฏุฉ ูุนุงูุฌุฉ ุงูุฑุณููุงุช 0 ุฅูู ูู ูุญุฏุฉ ูุนุงูุฌุฉ ุฑุณููุงุช.
    3. ูุชู ุชูููุฐ `forward`ุ ููุชู ุฅุฑุณุงู ุงูุฅุฎุฑุงุฌ ูู ูู ูุญุฏุฉ ูุนุงูุฌุฉ ุฑุณููุงุช ุฅูู ูุญุฏุฉ ูุนุงูุฌุฉ ุงูุฑุณููุงุช 0 ูุญุณุงุจ ุงูุฎุณุงุฑุฉ.
    4. ูุชู ุชูุฒูุน ุงูุฎุณุงุฑุฉ ูู ูุญุฏุฉ ูุนุงูุฌุฉ ุงูุฑุณููุงุช 0 ุฅูู ุฌููุน ูุญุฏุงุช ูุนุงูุฌุฉ ุงูุฑุณููุงุชุ ููุชู ุชุดุบูู `backward`.
    5. ูุชู ุฅุฑุณุงู ุงูุชุฏุฑุฌุงุช ูู ูู ูุญุฏุฉ ูุนุงูุฌุฉ ุฑุณููุงุช ุฅูู ูุญุฏุฉ ูุนุงูุฌุฉ ุงูุฑุณููุงุช 0 ููุชู ุญุณุงุจ ูุชูุณุทูุง.

ุชุดูู ุงูุงุฎุชูุงูุงุช ุงูุฑุฆูุณูุฉ ูุง ููู:

1. ูููู DDP ุจุชูููุฐ ุนูููุฉ ุงุชุตุงู ูุงุญุฏุฉ ููุท ููู ุฏูุนุฉ - ุฅุฑุณุงู ุงูุชุฏุฑุฌุงุชุ ูู ุญูู ุฃู DP ูููู ุจุฎูุณุฉ ุชุจุงุฏูุงุช ุจูุงูุงุช ูุฎุชููุฉ ููู ุฏูุนุฉ. ูููู DDP ุจูุณุฎ ุงูุจูุงูุงุช ุจุงุณุชุฎุฏุงู [torch.distributed] https://pytorch.org/docs/master/distributed.html)ุ ูู ุญูู ุฃู DP ููุณุฎ ุงูุจูุงูุงุช ุฏุงุฎู ุงูุนูููุฉ ุนุจุฑ ุฎููุท Python (ูุงูุชู ุชูุฏู ูููุฏูุง ูุฑุชุจุทุฉ ุจู GIL). ููุชูุฌุฉ ูุฐููุ ูุฅู "DistributedDataParallel" (DDP) ุฃุณุฑุน ุจุดูู ุนุงู ูู "DataParallel" (DP) ูุง ูู ููู ูุฏูู ุงุชุตุงู ุจุทูุก ุจูู ุจุทุงูุงุช ูุญุฏุงุช ูุนุงูุฌุฉ ุงูุฑุณููุงุช.
2. ูู DPุ ุชููู ูุญุฏุฉ ูุนุงูุฌุฉ ุงูุฑุณููุงุช 0 ุจุชูููุฐ ูุฏุฑ ุฃูุจุฑ ูู ุงูุนูู ููุงุฑูุฉ ุจูุญุฏุงุช ูุนุงูุฌุฉ ุงูุฑุณููุงุช ุงูุฃุฎุฑูุ ููุง ูุคุฏู ุฅูู ุงูุฎูุงุถ ุงุณุชุฎุฏุงู ูุญุฏุฉ ูุนุงูุฌุฉ ุงูุฑุณููุงุช.
3. ูุฏุนู DDP ุงูุชุฏุฑูุจ ุงูููุฒุน ุนุจุฑ ุฃุฌูุฒุฉ ูุชุนุฏุฏุฉุ ูู ุญูู ุฃู DP ูุง ูุฏุนู ุฐูู.

ูุฐู ููุณุช ูุงุฆูุฉ ุดุงููุฉ ุจุงูุงุฎุชูุงูุงุช ุจูู DP ูDDPุ ูููู ุงูุฏูุงุฆู ุงูุฃุฎุฑู ุฎุงุฑุฌ ูุทุงู ูุฐุง ุงูุฏููู. ููููู ุงูุญุตูู ุนูู ููู ุฃุนูู ููุฐู ุงูุทุฑู ูู ุฎูุงู ูุฑุงุกุฉ ูุฐู ุงูููุงูุฉ.

ุฏุนููุง ููุถุญ ุงูุงุฎุชูุงูุงุช ุจูู DP ูDDP ูู ุฎูุงู ุชุฌุฑุจุฉ. ุณูููู ุจุงุฎุชุจุงุฑ ุฃุฏุงุก DP ูDDP ูุน ุฅุถุงูุฉ ุณูุงู ูุฌูุฏ NVLink:

* ุงูุฃุฌูุฒุฉ: 2x TITAN RTX 24 ุฌูุฌุงุจุงูุช ููู ูููุง + NVlink ูุน 2 NVLinks (`NV2` ูู `nvidia-smi topo -m`).
* ุงูุจุฑูุฌูุงุช: `pytorch-1.8-to-be` + `cuda-11.0` / `transformers==4.3.0.dev0`.

ูุฅููุงู ููุฒุฉ NVLink ูู ุฃุญุฏ ุงูุงุฎุชุจุงุฑุงุชุ ูุณุชุฎุฏู `NCCL_P2P_DISABLE=1`.

ูููุง ููู ููุฏ ุงูุงุฎุชุจุงุฑ ูุฅุฎุฑุงุฌูุง:

**DP**

```bash
rm -r /tmp/test-clm; CUDA_VISIBLE_DEVICES=0,1 \
python examples/pytorch/language-modeling/run_clm.py \
--model_name_or_path openai-community/gpt2 --dataset_name wikitext --dataset_config_name wikitext-2-raw-v1 \
--do_train --output_dir /tmp/test-clm --per_device_train_batch_size 4 --max_steps 200

{'train_runtime': 110.5948, 'train_samples_per_second': 1.808, 'epoch': 0.69}
```

**DDP ูุน NVlink**

```bash
rm -r /tmp/test-clm; CUDA_VISIBLE_DEVICES=0,1 \
torchrun --nproc_per_node 2 examples/pytorch/language-modeling/run_clm.py \
--model_name_or_path openai-community/gpt2 --dataset_name wikitext --dataset_config_name wikitext-2-raw-v1 \
--do_train --output_dir /tmp/test-clm --per_device_train_batch_size 4 --max_steps 200

{'train_runtime': 101.9003, 'train_samples_per_second': 1.963, 'epoch': 0.69}
```

**DDP ุจุฏูู NVlink**

```bash
rm -r /tmp/test-clm; NCCL_P2P_DISABLE=1 CUDA_VISIBLE_DEVICES=0,1 \
torchrun --nproc_per_node 2 examples/pytorch/language-modeling/run_clm.py \
--model_name_or_path openai-community/gpt2 --dataset_name wikitext --dataset_config_name wikitext-2-raw-v1 \
--do_train --output_dir /tmp/test-clm --per_device_train_batch_size 4 --max_steps 200

{'train_runtime': 131.4367, 'train_samples_per_second': 1.522, 'epoch': 0.69}
```

ูููุง ููู ูุชุงุฆุฌ ุงูุงุฎุชุจุงุฑ ููุณูุง ูุฌูุนุฉ ูู ุฌุฏูู ููุฑุงุญุฉ:

| ุงูููุน | NVlink | ุงูููุช |
| :----- | -----  | ---: |
| 2:DP | Y | 110s |
| 2:DDP | Y | 101s |
| 2:DDP | N | 131s |

ููุง ุชุฑููุ ูู ูุฐู ุงูุญุงูุฉุ DP ุฃุจุทุฃ ุจูุณุจุฉ 10% ุชูุฑูุจูุง ูู DDP ูุน NVlinkุ ููููู ุฃุณุฑุน ุจูุณุจุฉ 15% ูู DDP ุจุฏูู NVlink. ุณูุนุชูุฏ ุงูุงุฎุชูุงู ุงูุญูููู ุนูู ููุฏุงุฑ ุงูุจูุงูุงุช ุงูุชู ุชุญุชุงุฌ ูู ูุญุฏุฉ ูุนุงูุฌุฉ ุฑุณููุงุช ุฅูู ูุฒุงููุชูุง ูุน ุงููุญุฏุงุช ุงูุฃุฎุฑู - ููููุง ุฒุงุฏุช ุงูุจูุงูุงุช ุงูุชู ูุฌุจ ูุฒุงููุชูุงุ ูููุง ุฃุนุงู ุงูุฑุงุจุท ุงูุจุทูุก ููุช ุงูุชุดุบูู ุงูุฅุฌูุงูู.

## ุงูุชูุงุฒู ูู ุงูุจูุงูุงุช ุจุงุณุชุฎุฏุงู ZeRO

ูุชู ุชูุถูุญ ุงูุชูุงุฒู ูู ุงูุจูุงูุงุช ุงููุฏุนูู ูู ZeRO (ZeRO-DP) ูู ุงูุฑุณู ุงูุจูุงูู ุงูุชุงูู ูู ูุฐู ุงูุชุฏูููุฉ.

ุนูู ุงูุฑุบู ูู ุฃูู ูุฏ ูุจุฏู ูุนูุฏูุงุ ุฅูุง ุฃูู ููููู ูุดุงุจู ุฌุฏูุง ูู `DataParallel` (DP). ุงููุฑู ูู ุฃูู ุจุฏูุงู ูู ูุณุฎ ูุนููุงุช ุงููููุฐุฌ ุงููุงููุฉ ูุงูุชุฏุฑุฌุงุช ูุญุงูุงุช ุงููุญุณูุ ุชููู ูู ูุญุฏุฉ ูุนุงูุฌุฉ ุฑุณููุงุช ุจุชุฎุฒูู ุดุฑูุญุฉ ููุท ูููุง. ุจุนุฏ ุฐููุ ูู ููุช ุงูุชุดุบูู ุนูุฏูุง ุชููู ูุนููุงุช ุงูุทุจูุฉ ุงููุงููุฉ ูุทููุจุฉ ููุท ููุทุจูุฉ ุงููุนุทุงุฉุ ุชุชู ูุฒุงููุฉ ุฌููุน ูุญุฏุงุช ูุนุงูุฌุฉ ุงูุฑุณููุงุช ูุฅุนุทุงุก ุจุนุถูุง ุงูุจุนุถ ุงูุฃุฌุฒุงุก ุงูุชู ุชูุชูุฏูุง.

ูุชูุถูุญ ูุฐู ุงูููุฑุฉุ ุถุน ูู ุงุนุชุจุงุฑู ูููุฐุฌูุง ุจุณูุทูุง ูุญุชูู ุนูู 3 ุทุจูุงุช (La ูLb ูLc)ุ ุญูุซ ุชุญุชูู ูู ุทุจูุฉ ุนูู 3 ูุนููุงุช. ุนูู ุณุจูู ุงููุซุงูุ ุชุญุชูู ุงูุทุจูุฉ La ุนูู ุงูุฃูุฒุงู a0 ูa1 ูa2:

```
La | Lb | Lc
---|----|---
a0 | b0 | c0
a1 | b1 | c1
a2 | b2 | c2
```

ุฅุฐุง ูุงู ูุฏููุง 3 ูุญุฏุงุช ูุนุงูุฌุฉ ุฑุณููุงุชุ ูุฅู ZeRO-DP ููุณู ุงููููุฐุฌ ุฅูู 3 ูุญุฏุงุช ูุนุงูุฌุฉ ุฑุณููุงุช ููุง ููู:

```
GPU0:
La | Lb | Lc
---|----|---
a0 | b0 | c0

GPU1:
La | Lb | Lc
---|----|---
a1 | b1 | c1

GPU2:
La | Lb | Lc
---|----|---
a2 | b2 | c2
```

ูุจุทุฑููุฉ ูุงุ ูุฐุง ูู ููุณ ุงูุชูุทูุน ุงูุฃููู ูุซู ุงูุชูุงุฒู ูู ุงููุตูููุงุชุ ุนูู ุนูุณ ุงูุชูุทูุน ุงูุฑุฃุณูุ ุญูุซ ูุชู ูุถุน ูุฌููุนุงุช ุงูุทุจูุงุช ุงููุงููุฉ ุนูู ูุญุฏุงุช ูุนุงูุฌุฉ ุงูุฑุณููุงุช ุงููุฎุชููุฉ. ุงูุขู ุฏุนููุง ูุฑู ููู ูุนูู ูุฐุง:

ุณุชุญุตู ูู ูู ูุญุฏุงุช ูุนุงูุฌุฉ ุงูุฑุณููุงุช ูุฐู ุนูู ุงูุฏูุนุฉ ุงููุตุบุฑุฉ ุงููุนุชุงุฏุฉ ููุง ูู ุงูุญุงู ูู DP:

```
x0 => GPU0
x1 => GPU1
x2 => GPU2
```

ูุชู ุชูุฑูุฑ ุงููุฏุฎูุงุช ุฏูู ุชุนุฏููุงุช ููุง ูู ูุงูุช ุณุชุชู ูุนุงูุฌุชูุง ุจูุงุณุทุฉ ุงููููุฐุฌ ุงูุฃุตูู.

ุฃููุงูุ ุชุตู ุงููุฏุฎูุงุช ุฅูู ุงูุทุจูุฉ "La". ูุงุฐุง ูุญุฏุซ ูู ูุฐู ุงููุฑุญูุฉุ

ุนูู ูุญุฏุฉ ูุนุงูุฌุฉ ุงูุฑุณููุงุช 0: ุชุชุทูุจ ุงูุฏูุนุฉ ุงููุตุบุฑุฉ x0 ุงููุนููุงุช a0 ูa1 ูa2 ููุงูุชูุงู ุนุจุฑ ุงููุณุงุฑ ุงูุฃูุงูู ููุทุจูุฉุ ูููู ุชุญุชูู ูุญุฏุฉ ูุนุงูุฌุฉ ุงูุฑุณููุงุช 0 ุนูู a0 ููุท. ุณูุญุตู ุนูู a1 ูู ูุญุฏุฉ ูุนุงูุฌุฉ ุงูุฑุณููุงุช 1 ูa2 ูู ูุญุฏุฉ ูุนุงูุฌุฉ ุงูุฑุณููุงุช 2ุ ููุง ูุฌูุน ุจูู ุฌููุน ูุทุน ุงููููุฐุฌ.

ุจุงูุชูุงุฒูุ ุชุญุตู ูุญุฏุฉ ูุนุงูุฌุฉ ุงูุฑุณููุงุช 1 ุนูู ุฏูุนุฉ ูุตุบุฑุฉ ุฃุฎุฑู - x1. ุชุญุชูู ูุญุฏุฉ ูุนุงูุฌุฉ ุงูุฑุณููุงุช 1 ุนูู ุงููุนููุฉ a1ุ ูููููุง ุชุญุชุงุฌ ุฅูู a0 ูa2ุ ูุฐุง ููู ุชุญุตู ุนูููุง ูู ูุญุฏุฉ ูุนุงูุฌุฉ ุงูุฑุณููุงุช 0 ููุญุฏุฉ ูุนุงูุฌุฉ ุงูุฑุณููุงุช 2.

ููุทุจู ุงูุดูุก ููุณู ุนูู ูุญุฏุฉ ูุนุงูุฌุฉ ุงูุฑุณููุงุช 2 ุงูุชู ุชุญุตู ุนูู ุงูุฏูุนุฉ ุงููุตุบุฑุฉ x2. ุชุญุตู ุนูู a0 ูa1 ูู ูุญุฏุฉ ูุนุงูุฌุฉ ุงูุฑุณููุงุช 0 ููุญุฏุฉ ูุนุงูุฌุฉ ุงูุฑุณููุงุช 1.

ุจูุฐู ุงูุทุฑููุฉุ ุชุญุตู ูู ูู ูุญุฏุงุช ูุนุงูุฌุฉ ุงูุฑุณููุงุช ุงูุซูุงุซ ุนูู ุงููุตูููุงุช ุงููุงููุฉ ุงููุนุงุฏ ุจูุงุคูุง ูุชููุฐ ุนูููุฉ ุงูุชูุงู ุฃูุงูู ุจูุฌููุนุฉ ุงูุจูุงูุงุช ุงููุตุบุฑุฉ ุงูุฎุงุตุฉ ุจูุง.

ุจูุฌุฑุฏ ุงูุงูุชูุงุก ูู ุงูุญุณุงุจุ ูุชู ุฅุณูุงุท ุงูุจูุงูุงุช ุงูุชู ูู ุชุนุฏ ููุงู ุญุงุฌุฉ ุฅูููุง - ูุชู ุงุณุชุฎุฏุงููุง ููุท ุฃุซูุงุก ุงูุญุณุงุจ. ูุชู ุชูููุฐ ุฅุนุงุฏุฉ ุงูุจูุงุก ุจููุงุกุฉ ุนุจุฑ ุงูุงุณุชุฑุฏุงุฏ ุงููุณุจู.

ุจุนุฏ ุฐููุ ูุชู ุชูุฑุงุฑ ุงูุนูููุฉ ุจุฃููููุง ููุทุจูุฉ Lbุ ุซู Lc ููุฃูุงูุ ุซู Lc -> Lb -> La ููุฎูู.

ูุฐู ุงูุขููุฉ ูุดุงุจูุฉ ูุงุณุชุฑุงุชูุฌูุฉ ุงูุชุฎููู ุงูุฌูุงุนู ุงููุนุงูุฉ: ูุญูู ุงูุดุฎุต A ุงูุฎููุฉุ ููุญูู ุงูุดุฎุต B ุงููููุฏุ ููุญูู ุงูุดุฎุต C ุงููุฃุณ. ูู ูููุฉ ูุชุดุงุฑููู ูุง ูุฏููู ูุน ุงูุขุฎุฑูู ููุญุตููู ุนูู ูุง ูุญุชุงุฌูู ุฅููู ูู ุงูุขุฎุฑููุ ููู ุงูุตุจุงุญ ูุญุฒููู ูุนุฏุงุชูู ุงููุฎุตุตุฉ ููุณุชูุฑูู ูู ุทุฑูููู. ูุฐุง ูู ูุง ููุนูู ZeRO DP/Sharded DDP.

ูุงุฑู ูุฐู ุงูุงุณุชุฑุงุชูุฌูุฉ ุจุงูุงุณุชุฑุงุชูุฌูุฉ ุงูุจุณูุทุฉ ุญูุซ ูุชุนูู ุนูู ูู ุดุฎุต ุญูู ุฎููุชู ููููุฏู ููุฃุณู (ูุดุงุจู ูู DataParallel (DP ูDDP) ูู PyTorch)ุ ูุงูุชู ุณุชููู ุฃูู ููุงุกุฉ ุจูุซูุฑ.

ุจูููุง ุชูุฑุฃ ุงูุฃุฏุจูุงุช ุญูู ูุฐุง ุงูููุถูุนุ ูุฏ ุชุตุงุฏู ุงููุฑุงุฏูุงุช ุงูุชุงููุฉ: ูุฌุฒุฃุฉุ ูุฌุฒุฃุฉ.

ุฅุฐุง ููุช ุชููู ุงูุชูุงููุง ูุซูููุง ููุทุฑููุฉ ุงูุชู ููุณู ุจูุง ZeRO ุฃูุฒุงู ุงููููุฐุฌุ ูุณุชุจุฏู ูุดุงุจูุฉ ุฌุฏูุง ููุชูุงุฒู ูู ุงููุตูููุงุช ูุงูุฐู ุณูุชู ููุงูุดุชู ูุงุญููุง. ููุฑุฌุน ุฐูู ุฅูู ุฃูู ููุณู/ูุดุธู ุฃูุฒุงู ูู ุทุจูุฉุ ุนูู ุนูุณ ุงูุชูุงุฒู ูู ุงููููุฐุฌ ุงูุฑุฃุณู ุงูุฐู ุชูุช ููุงูุดุชู ูุงุญููุง.

ุนูููุงุช ุงูุชูููุฐ:

- DeepSpeed ZeRO-DP ุงููุฑุงุญู 1+2+
## ุงููููุฐุฌ ุงูุณุงุฐุฌ ููุชูุงุฒู:

ุนูุฏูุง ุชูุชูู ุงูุจูุงูุงุช ูู ุงูุทุจูุฉ 0 ุฅูู ุงูุทุจูุฉ 3ุ ูุง ูุฎุชูู ุงูุฃูุฑ ุนู ุงููุฑูุฑ ุงูุฃูุงูู ุงูุนุงุฏู. ููุน ุฐููุ ูุชุทูุจ ุชูุฑูุฑ ุงูุจูุงูุงุช ูู ุงูุทุจูุฉ 3 ุฅูู ุงูุทุจูุฉ 4 ููููุง ูู GPU0 ุฅูู GPU1ุ ููุง ูุคุฏู ุฅูู ุญุฏูุซ ุชูููุฉ ุฅุถุงููุฉ ูู ุงูุงุชุตุงู. ุฅุฐุง ูุงูุช ูุญุฏุงุช GPU ุงููุดุงุฑูุฉ ููุฌูุฏุฉ ุนูู ููุณ ุงูุนูุฏุฉ ุงูุญุณุงุจูุฉ (ูุซู ููุณ ุงูุฌูุงุฒ ุงููุงุฏู)ุ ูุฅู ุนูููุฉ ุงููุณุฎ ุชููู ุณุฑูุนุฉุ ูููู ุฅุฐุง ูุงูุช ูุญุฏุงุช GPU ููุฒุนุฉ ุนูู ุนุฏุฉ ุนูุฏ ุญุณุงุจูุฉ (ูุซู ุฃุฌูุฒุฉ ูุชุนุฏุฏุฉ)ุ ููุฏ ุชููู ุงูุชูููุฉ ุงูุฅุถุงููุฉ ููุงุชุตุงู ุฃูุจุฑ ุจูุซูุฑ.

ุจุนุฏ ุฐููุ ุชุนูู ุงูุทุจูุงุช ูู 4 ุฅูู 7 ููุง ูู ูู ุงููููุฐุฌ ุงูุฃุตูู. ูุนูุฏ ุงูุงูุชูุงุก ูู ุงูุทุจูุฉ ุงูุณุงุจุนุฉุ ููุงู ุญุงุฌุฉ ูู ูุซูุฑ ูู ุงูุฃุญูุงู ุฅูู ุฅุฑุณุงู ุงูุจูุงูุงุช ูุฑุฉ ุฃุฎุฑู ุฅูู ุงูุทุจูุฉ 0 ุญูุซ ุชูุฌุฏ ุงูุชุณููุงุช (ุฃู ุจุฏูุงู ูู ุฐูู ุฅุฑุณุงู ุงูุชุณููุงุช ุฅูู ุงูุทุจูุฉ ุงูุฃุฎูุฑุฉ). ุงูุขู ูููู ุญุณุงุจ ุงูุฎุณุงุฑุฉ ููููู ูููุญุณู ุงูุฎุณุงุฑุฉ ุฃู ูููู ุจุนููู.

ูุฃุชู ุงููููุฐุฌ ุงูุณุงุฐุฌ ููุชูุงุฒู ูุน ุงูุนุฏูุฏ ูู ุฃูุฌู ุงููุตูุฑ:

- **ุฌููุน ูุญุฏุงุช GPU ูุง ุนุฏุง ูุงุญุฏุฉ ุฎุงููุฉ ูู ุฃู ูุญุธุฉ ูุนููุฉ**: ุฅุฐุง ุชู ุงุณุชุฎุฏุงู 4 ูุญุฏุงุช GPUุ ููุฐุง ูุดุงุจู ุชูุฑูุจูุง ููุถุงุนูุฉ ุฐุงูุฑุฉ GPU ูุงุญุฏุฉ ุฃุฑุจุน ูุฑุงุชุ ูุชุฌุงูู ุจููุฉ ุงูุฃุฌูุฒุฉ.

- **ุงูุชูููุฉ ุงูุฅุถุงููุฉ ูู ููู ุงูุจูุงูุงุช ุจูู ุงูุฃุฌูุฒุฉ**: ุนูู ุณุจูู ุงููุซุงูุ ูููู ูู 4x 6GB cards ุงุณุชูุนุงุจ ููุณ ุงูุญุฌู ูุซู 1x 24GB card ุจุงุณุชุฎุฏุงู ุงููููุฐุฌ ุงูุณุงุฐุฌ ููุชูุงุฒูุ ูููู ุจุทุงูุฉ 24GB ูุงุญุฏุฉ ุณุชููู ุงูุชุฏุฑูุจ ุจุดูู ุฃุณุฑุนุ ูุฃููุง ูุง ุชุญุชูู ุนูู ุชูููุฉ ูุณุฎ ุงูุจูุงูุงุช. ููููุ ุนูู ุณุจูู ุงููุซุงูุ ุฅุฐุง ูุงู ูุฏูู ุจุทุงูุงุช 40 ุฌูุฌุงุจุงูุช ูุชุญุชุงุฌ ุฅูู ููุงุกูุฉ ูููุฐุฌ 45 ุฌูุฌุงุจุงูุชุ ูููููู ุฐูู ุจุงุณุชุฎุฏุงู 4x 40GB cards (ูููู ุจุงููุงุฏ ุจุณุจุจ ุญุงูุฉ ุงูุชุฏุฑุฌ ูููุญุณู ุงูุฎุณุงุฑุฉ).

- **ูุณุฎ ุงูุชุนูููุงุช ุงูุชูุถูุญูุฉ ุงููุดุชุฑูุฉ**: ูุฏ ุชุญุชุงุฌ ุงูุชุนูููุงุช ุงูุชูุถูุญูุฉ ุงููุดุชุฑูุฉ ุฅูู ูุณุฎูุง ุฐูุงุจูุง ูุฅูุงุจูุง ุจูู ูุญุฏุงุช GPU.

ุงูุขู ุจุนุฏ ุฃู ุชุนุฑูุช ุนูู ููููุฉ ุนูู ุงููููุฐุฌ ุงูุณุงุฐุฌ ููุชูุงุฒู ูุนููุจูุ ุฏุนูุง ูููู ูุธุฑุฉ ุนูู ุงูุชูุงุฒู ุงูุฃูุจูุจู (PP).

ุงูุชูุงุฒู ุงูุฃูุจูุจู ูุชุทุงุจู ุชูุฑูุจูุง ูุน ุงููููุฐุฌ ุงูุณุงุฐุฌ ููุชูุงุฒูุ ููููู ูุญู ูุดููุฉ ุชุนุทูู ูุญุฏุงุช GPU ุนู ุทุฑูู ุชูุณูู ุงูุฏูุนุฉ ุงููุงุฑุฏุฉ ุฅูู ุฏูุนุงุช ุตุบูุฑุฉ ูุฅูุดุงุก ุฎุท ุฃูุงุจูุจ ุจุดูู ูุตุทูุนุ ููุง ูุณูุญ ููุญุฏุงุช GPU ุงููุฎุชููุฉ ุจุงููุดุงุฑูุฉ ุงููุชุฒุงููุฉ ูู ุนูููุฉ ุงูุญุณุงุจ.

ููุถุญ ุงูุฑุณู ุงูุชูุถูุญู ุงูุชุงูู ูู [ูุฑูุฉ GPipe](https://ai.googleblog.com/2019/03/introducing-gpipe-open-source-library.html) ุงููููุฐุฌ ุงูุณุงุฐุฌ ููุชูุงุฒู ูู ุงูุฃุนููุ ูุงูุชูุงุฒู ุงูุฃูุจูุจู ูู ุงูุฃุณูู:

ููููู ููุงุญุธุฉ ุฃู ุงูุชูุงุฒู ุงูุฃูุจูุจู ูู ุฃุณูู ุงูุฑุณู ุงูุชุฎุทูุทู ูููู ูู ุนุฏุฏ ุงูููุงุทู ุงูุฎุงููุฉ ููุญุฏุฉ GPUุ ุงููุดุงุฑ ุฅูููุง ุจุงุณู "ุงูููุงุนุงุช". ููุธูุฑ ููุง ุฌุฒุฃู ุงูุฑุณู ุงูุชุฎุทูุทู ูุณุชูููุง ูู ุงูุชูุงุฒู ูู ุงูุฏุฑุฌุฉ 4ุ ููุง ูุนูู ุฃู ููุงู 4 ูุญุฏุงุช GPU ูุดุงุฑูุฉ ูู ุฎุท ุงูุฃูุงุจูุจ. ูููููู ุฃู ุชุฑู ุฃู ููุงู ูุณุงุฑูุง ุฃูุงูููุง ูููููุง ูู 4 ูุฑุงุญู ุฃูุงุจูุจ (F0ุ F1ุ F2ุ ูF3) ููููุง ูุณุงุฑ ุนูุณู ุจุงูุชุฑุชูุจ ุงููุนุงูุณ (B3ุ B2ุ B1ุ ูB0).

ููุฏู ุงูุชูุงุฒู ุงูุฃูุจูุจู ููุญุณู ุฎุณุงุฑุฉ ุฌุฏูุฏูุง ููุถุจุท - "chunks"ุ ูุงูุฐู ูุญุฏุฏ ุนุฏุฏ ูุทุน ุงูุจูุงูุงุช ุงููุฑุณูุฉ ูู ุชุณูุณู ุนุจุฑ ููุณ ูุฑุญูุฉ ุงูุฃูุจูุจ. ุนูู ุณุจูู ุงููุซุงูุ ูู ุงูุฑุณู ุงูุชุฎุทูุทู ุงูุณูููุ ููููู ุฑุคูุฉ "chunks=4". ุชููู ูุญุฏุฉ GPU0 ุจุฃุฏุงุก ููุณ ุงููุณุงุฑ ุงูุฃูุงูู ุนูู ุงููุทุนุฉ 0 ู1 ู2 ู3 (F0ุ0ุ F0ุ1ุ F0ุ2ุ F0ุ3) ุซู ุชูุชุธุฑ ุญุชู ุชูุชูู ูุญุฏุงุช GPU ุงูุฃุฎุฑู ูู ุนูููุง. ููุง ุชุจุฏุฃ ูุญุฏุฉ GPU0 ุงูุนูู ูุฑุฉ ุฃุฎุฑู ุฅูุง ุนูุฏูุง ุชุจุฏุฃ ูุญุฏุงุช GPU ุงูุฃุฎุฑู ูู ุฅููุงู ุนูููุงุ ุญูุซ ุชููู ุจุงููุณุงุฑ ุงูุนูุณู ูููุทุน 3 ู2 ู1 ู0 (B0ุ3ุ B0ุ2ุ B0ุ1ุ B0ุ0).

ูุงุญุธ ุฃู ูุฐุง ูู ููุณ ููููู ุฎุทูุงุช ุชุฌููุน ุงูุชุฏุฑุฌุงุช. ูุณุชุฎุฏู PyTorch "chunks"ุ ุจูููุง ูุดูุฑ DeepSpeed ุฅูู ููุณ ููุญุณู ุงูุฎุณุงุฑุฉ ุจุงุณู ุฎุทูุงุช ุชุฌููุน ุงูุชุฏุฑุฌุงุช.

ุจุณุจุจ "chunks"ุ ููุฏู ุงูุชูุงุฒู ุงูุฃูุจูุจู ููููู ุงูุฏูุนุงุช ุงูุตุบูุฑุฉ (MBS). ูููุณู DP ุญุฌู ุงูุฏูุนุฉ ุงูุฅุฌูุงููุฉ ููุจูุงูุงุช ุฅูู ุฏูุนุงุช ุตุบูุฑุฉุ ูุฐุง ุฅุฐุง ูุงู ูุฏูู ุฏุฑุฌุฉ DP ุชุณุงูู 4ุ ูุชู ุชูุณูู ุญุฌู ุฏูุนุฉ ุนุงูููุฉ ุชุณุงูู 1024 ุฅูู 4 ุฏูุนุงุช ุตุบูุฑุฉ ูุจูุบ ุญุฌู ูู ูููุง 256 (1024/4). ูุฅุฐุง ูุงู ุนุฏุฏ "chunks" (ุฃู GAS) ูู 32ุ ูุฅููุง ูุญุตู ุนูู ุญุฌู ุฏูุนุฉ ุตุบูุฑุฉ ูุณุงูู 8 (256/32). ูุชุนูู ูู ูุฑุญูุฉ ูู ูุฑุงุญู ุฎุท ุงูุฃูุงุจูุจ ูุน ุฏูุนุฉ ุตุบูุฑุฉ ูุงุญุฏุฉ ูู ูู ูุฑุฉ. ูุญุณุงุจ ุญุฌู ุงูุฏูุนุฉ ุงูุนุงูููุฉ ูุฅุนุฏุงุฏ DP + PPุ ุงุณุชุฎุฏู ุงูุตูุบุฉ ุงูุชุงููุฉ: "mbs * chunks * dp_degree" ("8 * 32 * 4 = 1024").

ูุน "chunks=1"ุ ุณุชุญุตู ุนูู ุงููููุฐุฌ ุงูุณุงุฐุฌ ููุชูุงุฒูุ ููู ุบูุฑ ูุนุงู. ูุน ูููุฉ ูุจูุฑุฉ ูู "chunks"ุ ุณุชุญุตู ุนูู ุฃุญุฌุงู ุฏูุนุงุช ุตุบูุฑุฉ ุฌุฏูุง ููู ุฃูุถูุง ุบูุฑ ูุนุงู. ููุฐุง ุงูุณุจุจุ ูุดุฌุนู ุนูู ุชุฌุฑุจุฉ ูููุฉ "chunks" ูุฅูุฌุงุฏ ุงููููุฉ ุงูุชู ุชุคุฏู ุฅูู ุฃูุซุฑ ุงุณุชุฎุฏุงู ูุนุงู ููุญุฏุงุช GPU.

ูุฏ ุชูุงุญุธ ูุฌูุฏ "ููุงุนุฉ" ูู ุงูููุช "ุงูููุช" ูู ุงูุฑุณู ุงูุชุฎุทูุทู ูุง ูููู ุฅุฌุฑุงุก ุงูุชูุงุฒู ููุง ูุฃู ูุฑุญูุฉ "ุงูุชูุฏู" ุงูุฃุฎูุฑุฉ ูุฌุจ ุฃู ุชูุชุธุฑ ุงูุชูุงู ูุฑุญูุฉ "ุงูุนูุฏุฉ" ูุฅููุงู ุฎุท ุงูุฃูุงุจูุจ. ูุงูุบุฑุถ ูู ุฅูุฌุงุฏ ุฃูุถู ูููุฉ ูู "chunks" ูู ุชูููู ุงูุงุณุชุฎุฏุงู ุงููุชุฒุงูู ุงูุนุงูู ููุญุฏุฉ GPU ุนุจุฑ ุฌููุน ูุญุฏุงุช GPU ุงููุดุงุฑูุฉุ ููุง ูุคุฏู ุฅูู ุชูููู ุญุฌู "ุงูููุงุนุฉ".

ุชู ุชูููุฐ ุญููู ูุงุฌูุฉ ุจุฑูุฌุฉ ุงูุชุทุจููุงุช (API) ูุฎุท ุงูุฃูุงุจูุจ ูู:

- PyTorch
- DeepSpeed
- Megatron-LM

ุชุฃุชู ูุฐู ุงูุญููู ุจุจุนุถ ุฃูุฌู ุงููุตูุฑ:

- ูุฌุจ ุฃู ุชุนุฏู ุงููููุฐุฌ ุจุดูู ูุจูุฑุ ูุฃู ุฎุท ุงูุฃูุงุจูุจ ูุชุทูุจ ุฅุนุงุฏุฉ ูุชุงุจุฉ ุงูุชุฏูู ุงูุนุงุฏู ูููุญุฏุงุช ุงูููุทูุฉ ุฅูู ุชุณูุณู "nn.Sequential" ูู ููุณ ุงูููุนุ ูุงูุฐู ูุฏ ูุชุทูุจ ุฅุฌุฑุงุก ุชุบููุฑุงุช ุนูู ุชุตููู ุงููููุฐุฌ.

- ุญุงูููุงุ ูุงุฌูุฉ ุจุฑูุฌุฉ ุชุทุจููุงุช ุฎุท ุงูุฃูุงุจูุจ ูููุฏุฉ ููุบุงูุฉ. ุฅุฐุง ูุงู ูุฏูู ูุฌููุนุฉ ูู ุงููุชุบูุฑุงุช ูู Python ูุชู ุชูุฑูุฑูุง ูู ุงููุฑุญูุฉ ุงูุฃููู ูู ุฎุท ุงูุฃูุงุจูุจุ ูุณูู ูุชุนูู ุนููู ุฅูุฌุงุฏ ุทุฑููุฉ ููุชุนุงูู ูุน ุฐูู. ุญุงูููุงุ ุชุชุทูุจ ูุงุฌูุฉ ุฎุท ุงูุฃูุงุจูุจ ุฅูุง Tensor ูุงุญุฏุฉ ุฃู ูุฌููุนุฉ ูู Tensors ูุฅุฏุฎุงู ูุฅุฎุฑุงุฌ ูุญูุฏูู. ูุฌุจ ุฃู ูููู ููุฐู ุงููุตูููุงุช ุญุฌู ุฏูุนุฉ ูุฃูู ุจูุนุฏุ ูุธุฑูุง ูุฃู ุฎุท ุงูุฃูุงุจูุจ ุณูููู ุจุชูุณูู ุงูุฏูุนุฉ ุงูุตุบูุฑุฉ ุฅูู ุฏูุนุงุช ุตุบูุฑุฉ. ุชุชู ููุงูุดุฉ ุงูุชุญุณููุงุช ุงููุญุชููุฉ ููุง https://github.com/pytorch/pytorch/pull/50693

- ูุง ูููู ุฅุฌุฑุงุก ุชุฏูู ุงูุชุญูู ุงูุดุฑุทู ุนูู ูุณุชูู ูุฑุงุญู ุงูุฃูุงุจูุจ - ุนูู ุณุจูู ุงููุซุงูุ ุชุชุทูุจ ููุงุฐุฌ Encoder-Decoder ูุซู T5 ุญููููุง ุฎุงุตุฉ ููุชุนุงูู ูุน ูุฑุญูุฉ Encoder ุดุฑุทูุฉ.

- ูุฌุจ ุฃู ุชููู ุจุชุฑุชูุจ ูู ุทุจูุฉ ุจุญูุซ ูุตุจุญ ุฅุฎุฑุงุฌ ุฅุญุฏู ุงูุทุจูุงุช ุฅุฏุฎุงููุง ููุทุจูุฉ ุงูุฃุฎุฑู.

ุชุดูู ุงูุญููู ุงูุฃุญุฏุซ ูุง ููู:

- Varuna
- Sagemaker

ูู ูุฌุฑุจ Varuna ูSageMakerุ ูููู ุชุดูุฑ ุฃูุฑุงูููุง ุฅูู ุฃูููุง ุชุบูุจุง ุนูู ูุงุฆูุฉ ุงููุดููุงุช ุงููุฐููุฑุฉ ุฃุนูุงู ูุฃูููุง ูุชุทูุจุงู ุฅุฌุฑุงุก ุชุบููุฑุงุช ุฃูู ุนูู ูููุฐุฌ ุงููุณุชุฎุฏู.

ุงูุชุทุจููุงุช:

- [PyTorch](https://pytorch.org/docs/stable/pipeline.html) (ุฏุนู ุฃููู ูู pytorch-1.8ุ ูุชุญุณูู ุชุฏุฑูุฌู ูู 1.9 ูุจุดูู ุฃูุจุฑ ูู 1.10). ุจุนุถ [ุงูุฃูุซูุฉ](https://github.com/pytorch/pytorch/blob/master/benchmarks/distributed/pipeline/pipe.py)

- [DeepSpeed](https://www.deepspeed.ai/tutorials/pipeline/)

- [Megatron-LM](https://github.com/NVIDIA/Megatron-LM) ูุฏูู ุชุทุจูู ุฏุงุฎูู - ูุง ููุฌุฏ ูุงุฌูุฉ ุจุฑูุฌุฉ ุชุทุจููุงุช.

- [Varuna](https://github.com/microsoft/varuna)

- [SageMaker](https://arxiv.org/abs/2111.05972) - ูุฐุง ุญู ููููู ูุง ูููู ุงุณุชุฎุฏุงูู ุฅูุง ุนูู AWS.

- [OSLO](https://github.com/tunib-ai/oslo) - ุชู ุชูููุฐู ุจูุงุกู ุนูู ูุญููุงุช Hugging Face.

ุญุงูุฉ ูุญููุงุช ๐ค: ุงุนุชุจุงุฑูุง ูู ููุช ูุชุงุจุฉ ูุฐุง ุงูุชูุฑูุฑุ ูุง ูุฏุนู ุฃู ูู ุงูููุงุฐุฌ ุงูุชูุงุฒู ุงูุฃูุจูุจู ุงููุงูู. ูุชุฏุนู ููุงุฐุฌ GPT2 ูT5 ุงููููุฐุฌ ุงูุณุงุฐุฌ ููุชูุงุฒู.

ุงูุนูุจุฉ ุงูุฑุฆูุณูุฉ ูู ุนุฏู ุงููุฏุฑุฉ ุนูู ุชุญููู ุงูููุงุฐุฌ ุฅูู "nn.Sequential" ูุฌุนู ุฌููุน ุงูุฅุฏุฎุงูุงุช Tensors. ููุฑุฌุน ุฐูู ุฅูู ุฃู ุงูููุงุฐุฌ ุชุญุชูู ุญุงูููุง ุนูู ุงูุนุฏูุฏ ูู ุงูููุฒุงุช ุงูุชู ุชุฌุนู ุงูุชุญููู ูุนูุฏูุง ููุบุงูุฉุ ูุณูุชุนูู ุฅุฒุงูุชูุง ูุชุญููู ุฐูู.

ุชูุงููุงุช DeepSpeed ูMegatron-LM ูุชููุฑุฉ ูู [๐ค Accelerate](https://huggingface.co/docs/accelerate/main/en/usage_guides/deepspeed).

ุงูุฃุณุงููุจ ุงูุฃุฎุฑู:

ุชูุงููุงุช DeepSpeed ูMegatron-LM ูุชููุฑุฉ ูู [๐ค Accelerate](https://huggingface.co/docs/accelerate/main/en/usage_guides/deepspeed).

## ุงูุชูุงุฒู ุงูุฃูุจูุจู + ุงูุชูุงุฒู ูู ุงูุจูุงูุงุช:

ููุถุญ ุงูุฑุณู ุงูุชุฎุทูุทู ุงูุชุงูู ูู ุชุนูููู ุฎุท ุฃูุงุจูุจ DeepSpeed ููููุฉ ุงูุฌูุน ุจูู ุงูุชูุงุฒู ูู ุงูุจูุงูุงุช ูุงูุชูุงุฒู ุงูุฃูุจูุจู.

ูู ุงูููู ููุง ููุงุญุธุฉ ููู ุฃู ุชุฑุชูุจ DP 0 ูุง ูุฑู GPU2 ูุชุฑุชูุจ DP 1 ูุง ูุฑู GPU3. ุจุงููุณุจุฉ ุฅูู DPุ ููุงู ููุท ูุญุฏุงุช GPU 0 ู1 ุญูุซ ูุชู ุฅุฏุฎุงู ุงูุจูุงูุงุช ููุง ูู ูุงู ููุงู ูุญุฏุชู GPU ููุท. ูุชููู ูุญุฏุฉ GPU0 ุจุชูุฑูุบ ุจุนุถ ุนุจุฆูุง ุณุฑูุง ุนูู ูุญุฏุฉ GPU2 ุจุงุณุชุฎุฏุงู ุงูุชูุงุฒู ุงูุฃูุจูุจู. ูุชููู ูุญุฏุฉ GPU1 ุจููุณ ุงูุดูุก ุนู ุทุฑูู ุงูุงุณุชุนุงูุฉ ุจูุญุฏุฉ GPU3.

ูุธุฑูุง ูุฃู ูู ุจูุนุฏ ูุชุทูุจ ูุญุฏุชู GPU ุนูู ุงูุฃููุ ูุฃูุช ุจุญุงุฌุฉ ุฅูู 4 ูุญุฏุงุช GPU ุนูู ุงูุฃูู ููุง.

ุงูุชุทุจููุงุช:

- [DeepSpeed](https://github.com/microsoft/DeepSpeed)

- [Megatron-LM](https://github.com/NVIDIA/Megatron-LM)

- [Varuna](https://github.com/microsoft/varuna)

- [SageMaker](https://arxiv.org/abs/2111.05972)

- [OSLO](https://github.com/tunib-ai/oslo)

ุญุงูุฉ ูุญููุงุช ๐ค: ูู ูุชู ุงูุชูููุฐ ุจุนุฏ

## ุงูุชูุงุฒู ูู ุงูุจูุงูุงุช + ุงูุชูุงุฒู ุงูุฃูุจูุจู + ุงูุชูุงุฒู ูู ุงููุตูููุงุช:

ููุญุตูู ุนูู ุชุฏุฑูุจ ุฃูุซุฑ ููุงุกุฉุ ูุชู ุงุณุชุฎุฏุงู ุงูุชูุงุฒู ุซูุงุซู ุงูุฃุจุนุงุฏ ุญูุซ ูุชู ุงูุฌูุน ุจูู ุงูุชูุงุฒู ุงูุฃูุจูุจู ูุงูุชูุงุฒู ูู ุงููุตูููุงุช ูุงูุชูุงุฒู ูู ุงูุจูุงูุงุช. ููููู ุฑุคูุฉ ุฐูู ูู ุงูุฑุณู ุงูุชุฎุทูุทู ุงูุชุงูู.

ูุฐุง ุงูุฑุณู ุงูุชุฎุทูุทู ูุฃุฎูุฐ ูู ููุดูุฑ ูุฏููุฉ ุจุนููุงู "ุงูุชูุงุฒู ุซูุงุซู ุงูุฃุจุนุงุฏ: ุงูุชุฏุฑุฌ ุนูู ููุงุฐุฌ ุฐุงุช ูุนููุงุช ุงูุชุฑููููู" https://www.microsoft.com/en-us/research/blog/deepspeed-extreme-scale-model-training-for-everyone/)ุ ููู ุฃูุถูุง ูุฑุงุกุฉ ุฌูุฏุฉ.

ูุธุฑูุง ูุฃู ูู ุจูุนุฏ ูุชุทูุจ ูุญุฏุชู GPU ุนูู ุงูุฃููุ ูุฃูุช ุจุญุงุฌุฉ ุฅูู 8 ูุญุฏุงุช GPU ุนูู ุงูุฃูู ููุง.

ุงูุชุทุจููุงุช:

- [DeepSpeed](https://github.com/microsoft/DeepSpeed) - ูุชุถูู DeepSpeed ุฃูุถูุง ุชูุงุฒููุง ุฃูุซุฑ ููุงุกุฉ ูู ุงูุจูุงูุงุชุ ูุงูุฐู ูุทูููู ุนููู ุงุณู ZeRO-DP.

- [Megatron-LM](https://github.com/NVIDIA/Megatron-LM)

- [Varuna](https://github.com/microsoft/varuna)

- [SageMaker](https://arxiv.org/abs/2111.05972)

- [OSLO](https://github.com/tunib-ai/oslo)

ุญุงูุฉ ูุญููุงุช ๐ค: ูู ูุชู ุงูุชูููุฐ ุจุนุฏุ ุญูุซ ูุง ููุฌุฏ ุชูุงุฒู ุฃูุจูุจู ุฃู ุชูุงุฒู ูู ุงููุตูููุงุช.

## ุงูุชูุงุฒู ูู ุงูุจูุงูุงุช ุจุงุณุชุฎุฏุงู ZeRO + ุงูุชูุงุฒู ุงูุฃูุจูุจู + ุงูุชูุงุฒู ูู ุงููุตูููุงุช:

ุชุชูุซู ุฅุญุฏู ุงูููุฒุงุช ุงูุฑุฆูุณูุฉ ูู DeepSpeed ูู ZeROุ ููู ุงูุชุฏุงุฏ ูุงุจู ููุชุทููุฑ ููุบุงูุฉ ููุชูุงุฒู ูู ุงูุจูุงูุงุช. ููุฏ ุชูุช ููุงูุดุชู ุจุงููุนู ูู ูุณู [ุงูุชูุงุฒู ูู ุงูุจูุงูุงุช ุจุงุณุชุฎุฏุงู ZeRO](#zero-data-parallelism). ูุนุงุฏุฉ ูุง ูููู ููุฒุฉ ูุณุชููุฉ ูุง ุชุชุทูุจ ุงูุชูุงุฒู ุงูุฃูุจูุจู ุฃู ุงูุชูุงุฒู ูู ุงููุตูููุงุช. ูููู ูููู ุงูุฌูุน ุจููู ูุจูู ุงูุชูุงุฒู ุงูุฃูุจูุจู ูุงูุชูุงุฒู ูู ุงููุตูููุงุช.

ุนูุฏูุง ูุชู ุงูุฌูุน ุจูู ZeRO-DP ูุงูุชูุงุฒู ุงูุฃูุจูุจู (ูุจุดูู ุงุฎุชูุงุฑู ุงูุชูุงุฒู ูู ุงููุตูููุงุช)ุ ูุฅูู ููููู ุนุงุฏุฉู ูุฑุญูุฉ ZeRO 1 ููุท (ุชุฌุฒุฆุฉ ููุญุณู ุงูุฎุณุงุฑุฉ).

ุนูู ุงูุฑุบู ูู ุฃูู ูู ุงููููู ูุธุฑููุง ุงุณุชุฎุฏุงู ูุฑุญูุฉ ZeRO 2 (ุชุฌุฒุฆุฉ ุงูุชุฏุฑุฌ) ูุน ุงูุชูุงุฒู ุงูุฃูุจูุจูุ ุฅูุง ุฃูู ุณูููู ูู ุชุฃุซูุฑุงุช ุณูุจูุฉ ุนูู ุงูุฃุฏุงุก. ุณูุชุนูู ุฅุฌุฑุงุก ุนูููุฉ ุชุฌููุน ูุซุฑูุฉ ุฅุถุงููุฉ ููู ุฏูุนุฉ ุตุบูุฑุฉ ูุชุฌููุน ุงูุชุฏุฑุฌุงุช ูุจู ุงูุชุฌุฒุฆุฉุ ููุง ูุถูู ุชูููุฉ ุงุชุตุงู ูุญุชููุฉ ูุจูุฑุฉ. ูุจุณุจุจ ุงูุชูุงุฒู ุงูุฃูุจูุจูุ ูุชู ุงุณุชุฎุฏุงู ุฏูุนุงุช ุตุบูุฑุฉ ููุชู ุจุฏูุงู ูู ุฐูู ุงูุชุฑููุฒ ุนูู ูุญุงููุฉ ููุงุฒูุฉ ูุซุงูุฉ ุงูุญุณุงุจ (ุญุฌู ุงูุฏูุนุฉ ุงูุตุบูุฑุฉ) ูุน ุชูููู "ููุงุนุฉ" ุฎุท ุงูุฃูุงุจูุจ (ุนุฏุฏ ุงูุฏูุนุงุช ุงูุตุบูุฑุฉ). ูุจุงูุชุงููุ ูุฅู ุชูุงููู ุงูุงุชุตุงู ูุฐู ุณุชุคุซุฑ ุนูู ุงูุฃุฏุงุก.

ุจุงูุฅุถุงูุฉ ุฅูู ุฐููุ ููุงู ุจุงููุนู ุนุฏุฏ ุฃูู ูู ุงูุทุจูุงุช ุจุณุจุจ ุงูุชูุงุฒู ุงูุฃูุจูุจูุ ูุฐูู ูู ุชููู ูููุฑุงุช ุงูุฐุงูุฑุฉ ูุจูุฑุฉ. ููููู ุงูุชูุงุฒู ุงูุฃูุจูุจู ุจุงููุนู ูู ุญุฌู ุงูุชุฏุฑุฌ ุนู ุทุฑูู "1/PP"ุ ูุฐูู ูุฅู ูููุฑุงุช ุงูุชุฌุฒุฆุฉ ูู ุงูุชุฏุฑุฌ ุจุงูุฅุถุงูุฉ ุฅูู ุฐูู ุฃูู ุฃูููุฉ ูู ุงูุชูุงุฒู ูู ุงูุจูุงูุงุช ุงูููู.

ุงููุฑุญูุฉ 3 ูู ZeRO ููุณุช ุฎูุงุฑูุง ุฌูุฏูุง ูููุณ ุงูุณุจุจ - ุงูุญุงุฌุฉ ุฅูู ูุฒูุฏ ูู ุงูุงุชุตุงูุงุช ุจูู ุงูุนูุฏ.

ูุจูุง ุฃููุง ูุฏููุง ZeROุ ูุฅู ุงููุงุฆุฏุฉ ุงูุฃุฎุฑู ูู ZeRO-Offload. ูุจูุง ุฃู ูุฐู ูู ูุฑุญูุฉ 1ุ ููููู ุชูุฑูุบ ุญุงูุงุช ููุญุณู ุงูุฎุณุงุฑุฉ ุฅูู ูุญุฏุฉ ุงููุนุงูุฌุฉ ุงููุฑูุฒูุฉ.

ุงูุชุทุจููุงุช:

- [Megatron-DeepSpeed](https://github.com/microsoft/Megatron-DeepSpeed) ู [Megatron-Deepspeed ูู BigScience](https://github.com/bigscience-workshop/Megatron-DeepSpeed)ุ ููู ูุฑุน ูู ุงููุณุชูุฏุน ุงูุณุงุจู.

- [OSLO](https://github.com/tunib-ai/oslo)

ุงูุฃูุฑุงู ุงูุจุญุซูุฉ ุงููููุฉ:

- [Using DeepSpeed and Megatron to Train Megatron-Turing NLG 530B, A Large-Scale Generative Language Model](https://arxiv.org/abs/2201.11990)

ุญุงูุฉ ูุญููุงุช ๐ค: ูู ูุชู ุงูุชูููุฐ ุจุนุฏุ ุญูุซ ูุง ููุฌุฏ ุชูุงุฒู ุฃูุจูุจู ุฃู ุชูุงุฒู ูู ุงููุตูููุงุช.

## FlexFlow:

ูุญู FlexFlow ุฃูุถูุง ูุดููุฉ ุงูุชูุงุฒู ุจุทุฑููุฉ ูุฎุชููุฉ ููููุงู.

ุงููุฑูุฉ ุงูุจุญุซูุฉ: ["Beyond Data and Model Parallelism for Deep Neural Networks" by Zhihao Jia, Matei Zaharia, Alex Aiken](https://arxiv.org/abs/1807.05358)

ููุคุฏู ููุนูุง ูุง ูู ุงูุชูุงุฒู ุฑุจุงุนู ุงูุฃุจุนุงุฏ ุนูู Sample-Operator-Attribute-Parameter.

1. ุงูุนููุฉ = ุงูุชูุงุฒู ูู ุงูุจูุงูุงุช (ุชูุงุฒู ุนูู ูุณุชูู ุงูุนููุฉ)

2. ุงููุดุบู = ุชูุงุฒู ุนูููุฉ ูุงุญุฏุฉ ูู ุนุฏุฉ ุนูููุงุช ูุฑุนูุฉ

3. ุงูุณูุฉ = ุงูุชูุงุฒู ูู ุงูุจูุงูุงุช (ุชูุงุฒู ุนูู ูุณุชูู ุงูุทูู)

4. ุงููุนููุฉ = ุงูุชูุงุฒู ูู ุงููููุฐุฌ (ุจุบุถ ุงููุธุฑ ุนู ุงูุจูุนุฏ - ุฃููู ุฃู ุฑุฃุณู)

ุฃูุซูุฉ:

* ุงูุนููุฉ

ููุฃุฎุฐ 10 ุฏูุนุงุช ูู ุทูู ุงูุชุณูุณู 512. ุฅุฐุง ูููุง ุจุชูุงุฒููุง ุญุณุจ ุจูุนุฏ ุงูุนููุฉ ุฅูู ุฌูุงุฒู ููุจููุชุฑุ ูุณูุญุตู ุนูู 10 ร 512 ูุงูุชู ุชุตุจุญ 5 ร 2 ร 512.

* ุงููุดุบู

ุฅุฐุง ูููุง ุจุชุทุจูุน ุงูุทุจูุฉุ ูุฅููุง ูุญุณุจ ุงูุงูุญุฑุงู ุงููุนูุงุฑู ุฃููุงู ุซู ุงููุชูุณุทุ ูุจุนุฏ ุฐูู ูููููุง ุชุทุจูุน ุงูุจูุงูุงุช. ูุณูุญ ุชูุงุฒู ุงููุดุบู ุจุญุณุงุจ ุงูุงูุญุฑุงู ุงููุนูุงุฑู ูุงููุชูุณุท ูู ููุณ ุงูููุช. ูุฐููุ ุฅุฐุง ูููุง ุจุชูุงุฒููุง ุญุณุจ ุจูุนุฏ ุงููุดุบู ุฅูู ุฌูุงุฒู ููุจููุชุฑ (cuda:0ุ cuda:1)ุ ููุญู ูููู ุจูุณุฎ ุจูุงูุงุช ุงูุฅุฏุฎุงู
ูุนุฏ ุงููุนุฏ ุฌุฐุงุจูุง ููุบุงูุฉ - ููู ูุนูู ุนูู ูุญุงูุงุฉ ููุฏุฉ 30 ุฏูููุฉ ุนูู ูุฌููุนุฉ ุงูุฎูุงุฑุงุช ุงูุฎุงุตุฉ ุจู ููุฎุฑุฌ ุจุฃูุถู ุงุณุชุฑุงุชูุฌูุฉ ูุงุณุชุบูุงู ูุฐู ุงูุจูุฆุฉ ุงููุญุฏุฏุฉ. ุฅุฐุง ููุช ุจุฅุถุงูุฉ/ุฅุฒุงูุฉ/ุงุณุชุจุฏุงู ุฃู ุฃุฌุฒุงุกุ ูุณูููู ุจุงูุชุดุบูู ูุฅุนุงุฏุฉ ุชุญุณูู ุงูุฎุทุฉ ูุฐูู. ูุจุนุฏ ุฐูู ููููู ุงูุชุฏุฑูุจ. ุณูููู ููู ุฅุนุฏุงุฏ ูุฎุชูู ุชุญุณููู ุงูุฎุงุต.

๐ค ุญุงูุฉ ุงููุญููุงุช: ูููู ุชุชุจุน ููุงุฐุฌ ุงููุญููุงุช ุนุจุฑ [transformers.utils.fx](https://github.com/huggingface/transformers/blob/master/src/transformers/utils/fx.py)ุ ููู ุดุฑุท ุฃุณุงุณู ูู FlexFlowุ ููุน ุฐููุ ููุงู ุญุงุฌุฉ ุฅูู ุชุบููุฑุงุช ุนูู ุฌุงูุจ FlexFlow ูุฌุนูู ูุนูู ูุน ููุงุฐุฌ ุงููุญููุงุช.

## ุงุฎุชูุงุฑ ูุญุฏุฉ ูุนุงูุฌุฉ ุงูุฑุณููุงุช (GPU)

ุนูุฏ ุงูุชุฏุฑูุจ ุนูู ูุญุฏุงุช ูุนุงูุฌุฉ ุฑุณููุงุช ูุชุนุฏุฏุฉุ ููููู ุชุญุฏูุฏ ุนุฏุฏ ูุญุฏุงุช ูุนุงูุฌุฉ ุงูุฑุณููุงุช ุงูุชู ุชุฑูุฏ ุงุณุชุฎุฏุงููุง ูุงูุชุฑุชูุจ ุงูุฐู ุชุฑูุฏ ุงุณุชุฎุฏุงููุง ุจู. ูููู ุฃู ูููู ูุฐุง ูููุฏูุงุ ุนูู ุณุจูู ุงููุซุงูุ ุนูุฏูุง ูููู ูุฏูู ูุญุฏุงุช ูุนุงูุฌุฉ ุฑุณููุงุช ุฐุงุช ูุฏุฑุฉ ุญูุณุจุฉ ูุฎุชููุฉ ูุชุฑูุฏ ุงุณุชุฎุฏุงู ูุญุฏุฉ ูุนุงูุฌุฉ ุงูุฑุณููุงุช ุงูุฃุณุฑุน ุฃููุงู. ุชูุทุจู ุนูููุฉ ุงูุงุฎุชูุงุฑ ุนูู ูู ูู [DistributedDataParallel](https://pytorch.org/docs/stable/generated/torch.nn.parallel.DistributedDataParallel.html) ู [DataParallel](https://pytorch.org/docs/stable/generated/torch.nn.DataParallel.html) ูุงุณุชุฎุฏุงู ูุฌููุนุฉ ูุฑุนูุฉ ููุท ูู ูุญุฏุงุช ูุนุงูุฌุฉ ุงูุฑุณููุงุช ุงููุชููุฑุฉุ ููุง ุชุญุชุงุฌ ุฅูู Accelerate ุฃู [ุชูุงูู DeepSpeed](./main_classes/deepspeed).

### ุนุฏุฏ ูุญุฏุงุช ูุนุงูุฌุฉ ุงูุฑุณููุงุช

ุนูู ุณุจูู ุงููุซุงูุ ุฅุฐุง ูุงู ูุฏูู 4 ูุญุฏุงุช ูุนุงูุฌุฉ ุฑุณููุงุช ูุชุฑูุฏ ุงุณุชุฎุฏุงู ุฃูู ุงุซูุชูู ููุท:

<hfoptions id="select-gpu">
<hfoption id="torchrun">

ุงุณุชุฎุฏู `--nproc_per_node` ูุงุฎุชูุงุฑ ุนุฏุฏ ูุญุฏุงุช ูุนุงูุฌุฉ ุงูุฑุณููุงุช ุงูุชู ุชุฑูุฏ ุงุณุชุฎุฏุงููุง.

```bash
torchrun --nproc_per_node=2  trainer-program.py ...
```

</hfoption>
<hfoption id="Accelerate">

ุงุณุชุฎุฏู `--num_processes` ูุงุฎุชูุงุฑ ุนุฏุฏ ูุญุฏุงุช ูุนุงูุฌุฉ ุงูุฑุณููุงุช ุงูุชู ุชุฑูุฏ ุงุณุชุฎุฏุงููุง.

```bash
accelerate launch --num_processes 2 trainer-program.py ...
```

</hfoption>
<hfoption id="DeepSpeed">

ุงุณุชุฎุฏู `--num_gpus` ูุงุฎุชูุงุฑ ุนุฏุฏ ูุญุฏุงุช ูุนุงูุฌุฉ ุงูุฑุณููุงุช ุงูุชู ุชุฑูุฏ ุงุณุชุฎุฏุงููุง.

```bash
deepspeed --num_gpus 2 trainer-program.py ...
```

</hfoption>
</hfoptions>

### ุชุฑุชูุจ ูุญุฏุงุช ูุนุงูุฌุฉ ุงูุฑุณููุงุช

ุงูุขูุ ูุงุฎุชูุงุฑ ูุญุฏุงุช ูุนุงูุฌุฉ ุงูุฑุณููุงุช ุงูุชู ุชุฑูุฏ ุงุณุชุฎุฏุงููุง ูุชุฑุชูุจูุงุ ุงุณุชุฎุฏู ูุชุบูุฑ ุงูุจูุฆุฉ `CUDA_VISIBLE_DEVICES`. ูู ุงูุฃุณูู ุชุนููู ูุชุบูุฑ ุงูุจูุฆุฉ ูู `~/bashrc` ุฃู ููู ุชููุฆุฉ ุขุฎุฑ. ูุณุชุฎุฏู `CUDA_VISIBLE_DEVICES` ูุชุนููู ุฎุฑูุทุฉ ูุญุฏุงุช ูุนุงูุฌุฉ ุงูุฑุณููุงุช ุงููุณุชุฎุฏูุฉ. ุนูู ุณุจูู ุงููุซุงูุ ุฅุฐุง ูุงู ูุฏูู 4 ูุญุฏุงุช ูุนุงูุฌุฉ ุฑุณููุงุช (0ุ 1ุ 2ุ 3) ูุชุฑูุฏ ุชุดุบูู ูุญุฏุชู ูุนุงูุฌุฉ ุงูุฑุณููุงุช 0 ู 2 ููุท:

```bash
CUDA_VISIBLE_DEVICES=0,2 torchrun trainer-program.py ...
```

ุชููู ูุญุฏุชุง ูุนุงูุฌุฉ ุงูุฑุณููุงุช ุงููุนููุชุงู (0 ู 2) "ูุฑุฆูุชูู" ููุท ูู PyTorchุ ููุชู ุชุนูููููุง ุฅูู `cuda:0` ู `cuda:1` ุนูู ุงูุชูุงูู. ููููู ุฃูุถูุง ุนูุณ ุชุฑุชูุจ ูุญุฏุงุช ูุนุงูุฌุฉ ุงูุฑุณููุงุช ูุงุณุชุฎุฏุงู 2 ุฃููุงู. ุงูุขูุ ูุชู ุชุนููู ุงูุฎุฑูุทุฉ ุฅูู `cuda:1` ููุญุฏุฉ ูุนุงูุฌุฉ ุงูุฑุณููุงุช 0 ู `cuda:0` ููุญุฏุฉ ูุนุงูุฌุฉ ุงูุฑุณููุงุช 2.

```bash
CUDA_VISIBLE_DEVICES=2,0 torchrun trainer-program.py ...
```

ููููู ุฃูุถูุง ุชุนููู ูุชุบูุฑ ุงูุจูุฆุฉ `CUDA_VISIBLE_DEVICES` ุฅูู ูููุฉ ูุงุฑุบุฉ ูุฅูุดุงุก ุจูุฆุฉ ุจุฏูู ูุญุฏุงุช ูุนุงูุฌุฉ ุฑุณููุงุช.

```bash
CUDA_VISIBLE_DEVICES= python trainer-program.py ...
```

<Tip warning={true}>

ููุง ูู ุงูุญุงู ูุน ุฃู ูุชุบูุฑ ุจูุฆูุ ูููู ุชุตุฏูุฑูุง ุจุฏูุงู ูู ุฅุถุงูุชูุง ุฅูู ุณุทุฑ ุงูุฃูุงูุฑ. ููุน ุฐููุ ูุง ููุตู ุจุฐูู ูุฃูู ูููู ุฃู ูููู ูุฑุจููุง ุฅุฐุง ูุณูุช ููููุฉ ุฅุนุฏุงุฏ ูุชุบูุฑ ุงูุจูุฆุฉ ูุชุณุชุฎุฏู ูุญุฏุงุช ูุนุงูุฌุฉ ุงูุฑุณููุงุช ุงูุฎุทุฃ. ุจุฏูุงู ูู ุฐููุ ูู ุงูุดุงุฆุน ุชุนููู ูุชุบูุฑ ุงูุจูุฆุฉ ูุชุดุบูู ุชุฏุฑูุจ ูุญุฏุฏ ุนูู ููุณ ุณุทุฑ ุงูุฃูุงูุฑ.

</Tip>

`CUDA_DEVICE_ORDER` ูู ูุชุบูุฑ ุจูุฆู ุจุฏูู ููููู ุงุณุชุฎุฏุงูู ููุชุญูู ูู ููููุฉ ุชุฑุชูุจ ูุญุฏุงุช ูุนุงูุฌุฉ ุงูุฑุณููุงุช. ููููู ุชุฑุชูุจูุง ุฅูุง ุนู ุทุฑูู:

1. ูุนุฑูุงุช ุญุงููุฉ PCIe ุงูุชู ุชุชุทุงุจู ูุน ุชุฑุชูุจ ["nvidia-smi"](https://developer.nvidia.com/nvidia-system-management-interface) ู ["rocm-smi"](https://rocm.docs.amd.com/projects/rocm_smi_lib/en/latest/.doxygen/docBin/html/index.html) ููุญุฏุงุช ูุนุงูุฌุฉ ุงูุฑุณููุงุช NVIDIA ู AMD ุนูู ุงูุชูุงูู

```bash
export CUDA_DEVICE_ORDER=PCI_BUS_ID
```

2. ูุฏุฑุฉ ุงูุญูุณุจุฉ ููุญุฏุฉ ูุนุงูุฌุฉ ุงูุฑุณููุงุช

```bash
export CUDA_DEVICE_ORDER=FASTEST_FIRST
```
```bash
export CUDA_DEVICE_ORDER=PCI_BUS_ID
```

2. ูุฏุฑุฉ ุงูุญูุณุจุฉ ููุญุฏุฉ ูุนุงูุฌุฉ ุงูุฑุณููุงุช

```bash
export CUDA_DEVICE_ORDER=FASTEST_FIRST
```

`CUDA_DEVICE_ORDER` ูููุฏ ุจุดูู ุฎุงุต ุฅุฐุง ูุงูุช ูุฌููุนุฉ ุงูุชุฏุฑูุจ ุงูุฎุงุตุฉ ุจู ุชุชููู ูู ูุญุฏุฉ ูุนุงูุฌุฉ ุฑุณููุงุช ุฃูุฏู ูุฃุฎุฑู ุฃุญุฏุซุ ุญูุซ ุชุธูุฑ ูุญุฏุฉ ูุนุงูุฌุฉ ุงูุฑุณููุงุช ุงูุฃูุฏู ุฃููุงูุ ูููู ูุง ููููู ุงุณุชุจุฏุงู ุงูุจุทุงูุงุช ูุนูููุง ูุฌุนู ูุญุฏุฉ ูุนุงูุฌุฉ ุงูุฑุณููุงุช ุงูุฃุญุฏุซ ุชุธูุฑ ุฃููุงู. ูู ูุฐู ุงูุญุงูุฉุ ูู ุจุชุนููู `CUDA_DEVICE_ORDER=FASTEST_FIRST` ูุงุณุชุฎุฏุงู ูุญุฏุฉ ูุนุงูุฌุฉ ุงูุฑุณููุงุช ุงูุฃุญุฏุซ ูุงูุฃุณุฑุน ุฃููุงู (`nvidia-smi` ุฃู `rocm-smi` ูุง ูุฒุงู ูุจูุบ ุนู ูุญุฏุงุช ูุนุงูุฌุฉ ุงูุฑุณููุงุช ุงูุฎุงุตุฉ ุจูู ูู ุชุฑุชูุจ PCIe). ุฃู ููููู ุฃูุถูุง ุชุนููู `export CUDA_VISIBLE_DEVICES=1,0`.