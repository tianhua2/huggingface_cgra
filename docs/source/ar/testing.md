# ุงูุงุฎุชุจุงุฑ

ุฏุนููุง ูููู ูุธุฑุฉ ุนูู ููููุฉ ุงุฎุชุจุงุฑ ููุงุฐุฌ ๐ค Transformers ูููู ููููู ูุชุงุจุฉ ุงุฎุชุจุงุฑุงุช ุฌุฏูุฏุฉ ูุชุญุณูู ุงูุงุฎุชุจุงุฑุงุช ุงูุญุงููุฉ.

ููุงู ูุฌููุนุชุง ุงุฎุชุจุงุฑ ูู ุงููุณุชูุฏุน:

1. `tests` -- ุงุฎุชุจุงุฑุงุช ููุงุฌูุฉ ุจุฑูุฌุฉ ุงูุชุทุจููุงุช ุงูุนุงูุฉ
2. `examples` -- ุงุฎุชุจุงุฑุงุช ููุชุทุจููุงุช ุงููุฎุชููุฉ ุงูุชู ููุณุช ุฌุฒุกูุง ูู ูุงุฌูุฉ ุจุฑูุฌุฉ ุงูุชุทุจููุงุช

## ููููุฉ ุงุฎุชุจุงุฑ ุงููุญููุงุช

1. ุจูุฌุฑุฏ ุฅุฑุณุงู ุทูุจ ุณุญุจ (PR)ุ ูุชู ุงุฎุชุจุงุฑู ุจุงุณุชุฎุฏุงู 9 ูุธุงุฆู CircleCi. ุชุชู ุฅุนุงุฏุฉ ุงุฎุชุจุงุฑ ูู ุงูุชุฒุงู ุฌุฏูุฏ ููุฐุง ุงูุทูุจ. ูุชู ุชุญุฏูุฏ ูุฐู ุงููุธุงุฆู ูู [ููู ุงูุชูููู](https://github.com/huggingface/transformers/tree/main/.circleci/config.yml)ุ ุจุญูุซ ูููููุ ุฅุฐุง ูุฒู ุงูุฃูุฑุ ุฅุนุงุฏุฉ ุฅูุดุงุก ููุณ ุงูุจูุฆุฉ ุนูู ุฌูุงุฒู.

   ูุง ุชููู ูุธุงุฆู CI ูุฐู ุจุชุดุบูู ุงูุงุฎุชุจุงุฑุงุช `@slow`.

2. ููุงู 3 ูุธุงุฆู ูุชู ุชุดุบูููุง ุจูุงุณุทุฉ [GitHub Actions](https://github.com/huggingface/transformers/actions):

   - [ุชูุงูู ูุฑูุฒ ุงูุดุนูุฉ](https://github.com/huggingface/transformers/tree/main/.github/workflows/github-torch-hub.yml): ูุชุญูู ููุง ุฅุฐุง ูุงู ุชูุงูู ูุฑูุฒ ุงูุดุนูุฉ ูุนูู.
   - [ุฐุงุชู ุงูุงุณุชุถุงูุฉ (ุงูุฏูุน)](https://github.com/huggingface/transformers/tree/main/.github/workflows/self-push.yml): ุชุดุบูู ุงูุงุฎุชุจุงุฑุงุช ุงูุณุฑูุนุฉ ุนูู ูุญุฏุฉ ูุนุงูุฌุฉ ุงูุฑุณูููุงุช (GPU) ููุท ุนูู ุงูุงูุชุฒุงูุงุช ุนูู `main`. ูุง ูุชู ุชุดุบููู ุฅูุง ุฅุฐุง ุชู ุชุญุฏูุซ ุงูุงูุชุฒุงู ุนูู `main` ููุฑูุฒ ูู ุฃุญุฏ ุงููุฌูุฏุงุช ุงูุชุงููุฉ: `src`ุ `tests`ุ `.github` (ูููุน ุงูุชุดุบูู ุนูุฏ ุฅุถุงูุฉ ุจุทุงูุงุช ูููุฐุฌุ ุฏูุงุชุฑ ุงูููุงุญุธุงุชุ ุฅูุฎ).
   - [ูููุฐ ุฐุงุชู ุงูุงุณุชุถุงูุฉ](https://github.com/huggingface/transformers/tree/main/.github/workflows/self-scheduled.yml): ุชุดุบูู ุงูุงุฎุชุจุงุฑุงุช ุงูุนุงุฏูุฉ ูุงูุจุทูุฆุฉ ุนูู ูุญุฏุฉ ูุนุงูุฌุฉ ุงูุฑุณูููุงุช (GPU) ูู `tests` ู`examples`:

   ```bash
   RUN_SLOW=1 pytest tests/
   RUN_SLOW=1 pytest examples/
   ```

   ูููู ููุงุญุธุฉ ุงููุชุงุฆุฌ [ููุง](https://github.com/huggingface/transformers/actions).

## ุชุดุบูู ุงูุงุฎุชุจุงุฑุงุช

### ุงุฎุชูุงุฑ ุงูุงุฎุชุจุงุฑุงุช ุงูุชู ุณูุชู ุชุดุบูููุง

ุชุชุทุฑู ูุฐู ุงููุซููุฉ ุฅูู ุงูุนุฏูุฏ ูู ุงูุชูุงุตูู ุญูู ููููุฉ ุชุดุบูู ุงูุงุฎุชุจุงุฑุงุช. ุฅุฐุง ููุช ุจุนุฏ ูุฑุงุกุฉ ูู ุดูุกุ ูุง ุชุฒุงู ุจุญุงุฌุฉ ุฅูู ูุฒูุฏ ูู ุงูุชูุงุตููุ ูุณุชุฌุฏูุง [ููุง](https://docs.pytest.org/en/latest/usage.html).

ูููุง ููู ุจุนุถ ุงูุทุฑู ุงูุฃูุซุฑ ูุงุฆุฏุฉ ูุชุดุบูู ุงูุงุฎุชุจุงุฑุงุช.

ุชุดุบูู ุงููู:

```console
pytest
```

ุฃู:

```bash
make test
```

ูุงุญุธ ุฃู ุงูุฃุฎูุฑ ูุญุฏุฏ ุนูู ุงููุญู ุงูุชุงูู:

```bash
python -m pytest -n auto --dist=loadfile -s -v ./tests/
```

ุงูุฐู ูุฎุจุฑ pytest ุจุงูููุงู ุจูุง ููู:

- ุชุดุบูู ุฃูุจุฑ ุนุฏุฏ ูููู ูู ุนูููุงุช ุงูุงุฎุชุจุงุฑ ูุซู ุงูููู ุงููุฑูุฒูุฉ (ุงูุชู ูุฏ ุชููู ูุซูุฑุฉ ุฌุฏูุง ุฅุฐุง ูู ููู ูุฏูู ุงููุซูุฑ ูู ุฐุงูุฑุฉ ุงููุตูู ุงูุนุดูุงุฆู!)
- ุงูุชุฃูุฏ ูู ุฃู ุฌููุน ุงูุงุฎุชุจุงุฑุงุช ูู ููุณ ุงูููู ุณูุชู ุชุดุบูููุง ุจูุงุณุทุฉ ููุณ ุนูููุฉ ุงูุงุฎุชุจุงุฑ
- ูุง ุชูุชูุท ุงูุฅุฎุฑุงุฌ
- ุชุดุบูู ูู ุงููุถุน ุงูุชูุตููู

### ุงูุญุตูู ุนูู ูุงุฆูุฉ ุจุฌููุน ุงูุงุฎุชุจุงุฑุงุช

ุฌููุน ุงุฎุชุจุงุฑุงุช ูุฌููุนุฉ ุงูุงุฎุชุจุงุฑ:

```bash
pytest --collect-only -q
```

ุฌููุน ุงุฎุชุจุงุฑุงุช ููู ุงุฎุชุจุงุฑ ูุนูู:

```bash
pytest tests/test_optimization.py --collect-only -q
```

### ุชุดุบูู ูุญุฏุฉ ุงุฎุชุจุงุฑ ูุญุฏุฏุฉ

ูุชุดุบูู ูุญุฏุฉ ุงุฎุชุจุงุฑ ูุฑุฏูุฉ:

```bash
pytest tests/utils/test_logging.py
```

### ุชุดุบูู ุงุฎุชุจุงุฑุงุช ูุญุฏุฏุฉ

ูุธุฑูุง ูุงุณุชุฎุฏุงู unittest ุฏุงุฎู ูุนุธู ุงูุงุฎุชุจุงุฑุงุชุ ูุชุดุบูู ุงุฎุชุจุงุฑุงุช ูุฑุนูุฉ ูุญุฏุฏุฉุ ุชุญุชุงุฌ ุฅูู ูุนุฑูุฉ ุงุณู ูุฆุฉ unittest ุงูุชู ุชุญุชูู ุนูู ุชูู ุงูุงุฎุชุจุงุฑุงุช. ุนูู ุณุจูู ุงููุซุงูุ ูููู ุฃู ูููู:

```bash
pytest tests/test_optimization.py::OptimizationTest::test_adam_w
```

ููุง:

- `tests/test_optimization.py` - ุงูููู ุงูุฐู ูุญุชูู ุนูู ุงูุงุฎุชุจุงุฑุงุช
- `OptimizationTest` - ุงุณู ุงููุฆุฉ
- `test_adam_w` - ุงุณู ุฏุงูุฉ ุงูุงุฎุชุจุงุฑ ุงููุญุฏุฏุฉ

ุฅุฐุง ุงุญุชูู ุงูููู ุนูู ุนุฏุฉ ูุฆุงุชุ ูููููู ุงุฎุชูุงุฑ ุชุดุบูู ุงุฎุชุจุงุฑุงุช ูุฆุฉ ูุนููุฉ ููุท. ุนูู ุณุจูู ุงููุซุงู:

```bash
pytest tests/test_optimization.py::OptimizationTest
```

ุณูููู ุจุชุดุบูู ุฌููุน ุงูุงุฎุชุจุงุฑุงุช ุฏุงุฎู ุชูู ุงููุฆุฉ.

ููุง ุฐูุฑูุง ุณุงุจููุงุ ููููู ูุนุฑูุฉ ุงูุงุฎุชุจุงุฑุงุช ุงูููุฌูุฏุฉ ุฏุงุฎู ูุฆุฉ `OptimizationTest` ุจุชุดุบูู:

```bash
pytest tests/test_optimization.py::OptimizationTest --collect-only -q
```

ููููู ุชุดุบูู ุงูุงุฎุชุจุงุฑุงุช ุจุงุณุชุฎุฏุงู ุชุนุจูุฑุงุช ุงููููุงุช ุงูุฑุฆูุณูุฉ.

ูุชุดุบูู ุงูุงุฎุชุจุงุฑุงุช ุงูุชู ูุญุชูู ุงุณููุง ุนูู `adam` ููุท:

```bash
pytest -k adam tests/test_optimization.py
```

ูููู ุงุณุชุฎุฏุงู `and` ุงูููุทููุฉ ู`or` ููุฅุดุงุฑุฉ ุฅูู ูุง ุฅุฐุง ูุงู ูุฌุจ ูุทุงุจูุฉ ุฌููุน ุงููููุงุช ุงูุฑุฆูุณูุฉ ุฃู ุฃู ูููุง. ูููู ุงุณุชุฎุฏุงู `not` ูููู.

ูุชุดุบูู ุฌููุน ุงูุงุฎุชุจุงุฑุงุช ุจุงุณุชุซูุงุก ุชูู ุงูุชู ูุญุชูู ุงุณููุง ุนูู `adam`:

```bash
pytest -k "not adam" tests/test_optimization.py
```

ูููููู ุงูุฌูุน ุจูู ุงูููุทูู ูู ูุงุญุฏ:

```bash
pytest -k "ada and not adam" tests/test_optimization.py
```

ุนูู ุณุจูู ุงููุซุงูุ ูุชุดุบูู ูู ูู `test_adafactor` ู`test_adam_w`ุ ููููู ุงุณุชุฎุฏุงู:

```bash
pytest -k "test_adafactor or test_adam_w" tests/test_optimization.py
```

ูุงุญุธ ุฃููุง ูุณุชุฎุฏู `or` ููุงุ ูุฃููุง ูุฑูุฏ ูุทุงุจูุฉ ุฃู ูู ุงููููุงุช ุงูุฑุฆูุณูุฉ ูุฅุฏุฑุงุฌ ุงูุงุซููู.

ุฅุฐุง ููุช ุชุฑูุฏ ุชุถููู ุงูุงุฎุชุจุงุฑุงุช ุงูุชู ุชุญุชูู ุนูู ููุง ุงูููุทูู ููุทุ ููุฌุจ ุงุณุชุฎุฏุงู `and`:

```bash
pytest -k "test and ada" tests/test_optimization.py
```

### ุชุดุบูู ุงุฎุชุจุงุฑุงุช `accelerate`

ูู ุจุนุถ ุงูุฃุญูุงูุ ุชุญุชุงุฌ ุฅูู ุชุดุบูู ุงุฎุชุจุงุฑุงุช `accelerate` ุนูู ููุงุฐุฌู. ููููุงู ุจุฐููุ ููููู ููุท ุฅุถุงูุฉ `-m accelerate_tests` ุฅูู ุฃูุฑูุ ุฅุฐุง ููุช ุชุฑูุฏ ุชุดุบูู ูุฐู ุงูุงุฎุชุจุงุฑุงุช ุนูู `OPT`ุ ููู ุจุชุดุบูู:

```bash
RUN_SLOW=1 pytest -m accelerate_tests tests/models/opt/test_modeling_opt.py
```

### ุชุดุบูู ุงุฎุชุจุงุฑุงุช ุงูุชูุซูู

ูุงุฎุชุจุงุฑ ูุง ุฅุฐุง ูุงูุช ุฃูุซูุฉ ุงูุชูุซูู ุตุญูุญุฉุ ูุฌุจ ุงูุชุฃูุฏ ูู ุฃู `doctests` ูุงุฌุญุฉ.

ููุซุงูุ ุฏุนูุง ูุณุชุฎุฏู [docstring ูู `WhisperModel.forward`](https://github.com/huggingface/transformers/blob/main/src/transformers/models/whisper/modeling_whisper.py#L1017-L1035):

```python
r"""
Returns:

Example:
```python
>>> import torch
>>> from transformers import WhisperModel, WhisperFeatureExtractor
>>> from datasets import load_dataset
>>> model = WhisperModel.from_pretrained("openai/whisper-base")
>>> feature_extractor = WhisperFeatureExtractor.from_pretrained("openai/whisper-base")
>>> ds = load_dataset("hf-internal-testing/librispeech_asr_dummy", "clean", split="validation")
>>> inputs = feature_extractor(ds[0]["audio"]["array"], return_tensors="pt")
>>> input_features = inputs.input_features
>>> decoder_input_ids = torch.tensor([[1, 1]]) * model.config.decoder_start_token_id
>>> last_hidden_state = model(input_features, decoder_input_ids=decoder_input_ids).last_hidden_state
>>> list(last_hidden_state.shape)
[1, 2, 512]
```"""
```

ูู ุจุจุณุงุทุฉ ุจุชุดุบูู ุงูุณุทุฑ ุงูุชุงูู ูุงุฎุชุจุงุฑ ูู ูุซุงู docstring ุชููุงุฆููุง ูู ุงูููู ุงููุทููุจ:

```bash
pytest --doctest-modules <path_to_file_or_dir>
```

ุฅุฐุง ูุงู ููููู ููุญู markdownุ ููุฌุจ ุฅุถุงูุฉ ุงูุญุฌุฉ `--doctest-glob="*.md"`.

### ุชุดุบูู ุงูุงุฎุชุจุงุฑุงุช ุงููุนุฏูุฉ ููุท

ููููู ุชุดุบูู ุงูุงุฎุชุจุงุฑุงุช ุงููุชุนููุฉ ุจุงููููุงุช ุฃู ุงููุฑูุน ุบูุฑ ุงููุฑุญููุฉ (ููููุง ูู Git) ุจุงุณุชุฎุฏุงู [pytest-picked](https://github.com/anapaulagomes/pytest-picked). ูุฐู ุทุฑููุฉ ุฑุงุฆุนุฉ ูุงุฎุชุจุงุฑ ูุง ุฅุฐุง ูุงูุช ุงูุชุบููุฑุงุช ุงูุชู ุฃุฌุฑูุชูุง ูู ุชูุณุฑ ุฃู ุดูุก ุจุณุฑุนุฉุ ุญูุซ ูู ุชููู ุจุชุดุบูู ุงูุงุฎุชุจุงุฑุงุช ุงููุชุนููุฉ ุจุงููููุงุช ุงูุชู ูู ุชููุณูุง.

```bash
pip install pytest-picked
```

```bash
pytest --picked
```

ุณูุชู ุชุดุบูู ุฌููุน ุงูุงุฎุชุจุงุฑุงุช ูู ุงููููุงุช ูุงููุฌูุฏุงุช ุงูุชู ุชู ุชุนุฏูููุง ูููู ูู ูุชู ุงุฑุชูุงุจูุง ุจุนุฏ.
: ูุฐุง ุฏููู ุณุฑูุน ุญูู ููููุฉ ุชุดุบูู ุงุฎุชุจุงุฑุงุชูุง.

### ุฅุนุงุฏุฉ ุชุดุบูู ุงูุงุฎุชุจุงุฑุงุช ุงูุชู ูุดูุช ุชููุงุฆููุง ุนูุฏ ุชุนุฏูู ุงููุตุฏุฑ
ูููุฑ [pytest-xdist](https://github.com/pytest-dev/pytest-xdist) ููุฒุฉ ูููุฏุฉ ุฌุฏูุง ุชุชูุซู ูู ุงูุชุดุงู ุฌููุน ุงูุงุฎุชุจุงุฑุงุช ุงูุชู ูุดูุชุ ุซู ุงูุชุธุงุฑ ุชุนุฏูู ุงููููุงุช ูุฅุนุงุฏุฉ ุชุดุบูู ุงูุงุฎุชุจุงุฑุงุช ุงูุชู ูุดูุช ุจุงุณุชูุฑุงุฑ ุญุชู ุชูุฌุญ ุฃุซูุงุก ุฅุตูุงุญูุง. ุจุญูุซ ูุง ุชุญุชุงุฌ ุฅูู ุฅุนุงุฏุฉ ุชุดุบูู pytest ุจุนุฏ ุฅุฌุฑุงุก ุงูุฅุตูุงุญ. ููุณุชูุฑ ูุฐุง ุญุชู ูุฌุงุญ ุฌููุน ุงูุงุฎุชุจุงุฑุงุชุ ูุจุนุฏ ุฐูู ูุชู ุฅุฌุฑุงุก ุชุดุบูู ูุงูู ูุฑุฉ ุฃุฎุฑู.

```bash
pip install pytest-xdist
```

ููุฏุฎูู ุฅูู ุงููุถุน: `pytest -f` ุฃู `pytest --looponfail`

ูุชู ุงูุชุดุงู ุชุบููุฑุงุช ุงูููู ุนู ุทุฑูู ุงููุธุฑ ูู ุฏูุงุฆู ุงูุฌุฐุฑ looponfailroots ููุญุชููุงุชูุง ุจุงููุงูู (ุจุดูู ูุชูุฑุฑ). ุฅุฐุง ูู ููุฌุญ ุงูุงูุชุฑุงุถู ููุฐู ุงููููุฉุ ูููููู ุชุบููุฑู ูู ูุดุฑูุนู ุนู ุทุฑูู ุชุนููู ุฎูุงุฑ ุชูููู ูู setup.cfg:

```ini
[tool:pytest]
looponfailroots = transformers tests
```

ุฃู ูููุงุช pytest.ini/tox.ini:

```ini
[pytest]
looponfailroots = transformers tests
```

ุณูุคุฏู ูุฐุง ุฅูู ุงูุจุญุซ ููุท ุนู ุชุบููุฑุงุช ุงููููุงุช ูู ุฏูุงุฆู ุงูููุงุจูุฉุ ุงููุญุฏุฏุฉ ูุณุจููุง ุฅูู ุฏููู ููู ini.

[pytest-watch](https://github.com/joeyespo/pytest-watch) ูู ุชูููุฐ ุจุฏูู ููุฐู ุงููุธููุฉ.

### ุชุฎุทู ูููุฐุฌ ุงูุงุฎุชุจุงุฑ
ุฅุฐุง ููุช ุชุฑูุฏ ุชุดุบูู ุฌููุน ููุงุฐุฌ ุงูุงุฎุชุจุงุฑุ ุจุงุณุชุซูุงุก ุจุนุถูุงุ ูููููู ุงุณุชุจุนุงุฏูุง ุนู ุทุฑูู ุฅุนุทุงุก ูุงุฆูุฉ ุตุฑูุญุฉ ุจุงูุงุฎุชุจุงุฑุงุช ุงูุชู ุณูุชู ุชุดุบูููุง. ุนูู ุณุจูู ุงููุซุงูุ ูุชุดุบูู ุงููู ุจุงุณุชุซูุงุก ุงุฎุชุจุงุฑุงุช test_modeling_*.py:

```bash
pytest *ls -1 tests/*py | grep -v test_modeling*
```

### ูุณุญ ุงูุญุงูุฉ
ูุฌุจ ูุณุญ ุฐุงูุฑุฉ ุงูุชุฎุฒูู ุงููุคูุช ูู ุนูููุงุช ุงูุจูุงุก CI ูุนูุฏูุง ุชููู ุงูุนุฒูุฉ ูููุฉ (ุถุฏ ุงูุณุฑุนุฉ):

```bash
pytest --cache-clear tests
```

### ุชุดุบูู ุงูุงุฎุชุจุงุฑุงุช ุจุงูุชูุงุฒู
ููุง ุฐูุฑ ุณุงุจููุงุ ูููู make test ุจุชุดุบูู ุงูุงุฎุชุจุงุฑุงุช ุจุงูุชูุงุฒู ุนุจุฑ ุงููููู ุงูุฅุถุงูู pytest-xdist (`-n X` argumentุ ุนูู ุณุจูู ุงููุซุงู `-n 2` ูุชุดุบูู ูุธููุชูู ูุชูุงุฒูุชูู).

ูุณูุญ ุฎูุงุฑ `--dist=` ูู pytest-xdist ุจุงูุชุญูู ูู ููููุฉ ุชุฌููุน ุงูุงุฎุชุจุงุฑุงุช. ููุถุน `--dist=loadfile` ุงูุงุฎุชุจุงุฑุงุช ุงูููุฌูุฏุฉ ูู ููู ูุงุญุฏ ูู ููุณ ุงูุนูููุฉ.

ูุธุฑูุง ูุฃู ุชุฑุชูุจ ุงูุงุฎุชุจุงุฑุงุช ุงููููุฐุฉ ูุฎุชูู ููุง ูููู ุงูุชูุจุค ุจูุ ุฅุฐุง ุฃุฏู ุชุดุบูู ูุฌููุนุฉ ุงูุงุฎุชุจุงุฑุงุช ุจุงุณุชุฎุฏุงู pytest-xdist ุฅูู ุญุฏูุซ ูุดู (ููุง ูุนูู ูุฌูุฏ ุจุนุถ ุงูุงุฎุชุจุงุฑุงุช ุงูููุชุฑูุฉ ุบูุฑ ุงูููุชุดูุฉ)ุ ูุงุณุชุฎุฏู [pytest-replay](https://github.com/ESSS/pytest-replay) ูุฅุนุงุฏุฉ ุชุดุบูู ุงูุงุฎุชุจุงุฑุงุช ุจููุณ ุงูุชุฑุชูุจุ ูุงูุฐู ูุฌุจ ุฃู ูุณุงุนุฏ ูู ุชูููู ุชุณูุณู ุงููุดู ูุฐุง ุฅูู ุงูุญุฏ ุงูุฃุฏูู.

### ุชุฑุชูุจ ุงูุงุฎุชุจุงุฑ ูุงูุชูุฑุงุฑ
ูู ุงูุฌูุฏ ุชูุฑุงุฑ ุงูุงุฎุชุจุงุฑุงุช ุนุฏุฉ ูุฑุงุชุ ุจุงูุชุณูุณูุ ุฃู ุจุดูู ุนุดูุงุฆูุ ุฃู ูู ูุฌููุนุงุชุ ูููุดู ุนู ุฃู ุฃุฎุทุงุก ูุญุชููุฉ ูู ุงูุชุจุนูุฉ ุงููุชุจุงุฏูุฉ ูุงููุชุนููุฉ ุจุงูุญุงูุฉ (ุงูุฅููุงุก). ูุงูุชูุฑุงุฑ ุงููุชุนุฏุฏ ุงููุจุงุดุฑ ุฌูุฏ ูููุดู ุนู ุจุนุถ ุงููุดููุงุช ุงูุชู ุชูุดููุง ุงูุทุจูุนุฉ ุงูุนุดูุงุฆูุฉ ูุชุนูู ุงูุขูุฉ.

#### ุชูุฑุงุฑ ุงูุงุฎุชุจุงุฑุงุช
- [pytest-flakefinder](https://github.com/dropbox/pytest-flakefinder):

```bash
pip install pytest-flakefinder
```

ุซู ูู ุจุชุดุบูู ูู ุงุฎุชุจุงุฑ ุนุฏุฉ ูุฑุงุช (50 ุจุดูู ุงูุชุฑุงุถู):

```bash
pytest --flake-finder --flake-runs=5 tests/test_failing_test.py
```

<Tip>
ูุฐู ุงูุฅุถุงูุฉ ูุง ุชุนูู ูุน ุงูุนูุงูุฉ -n ูู pytest-xdist.
</Tip>

<Tip>
ููุงู ุฅุถุงูุฉ ุฃุฎุฑู ุชุณูู pytest-repeatุ ููููุง ูุง ุชุนูู ูุน unittest.
</Tip>

#### ุชุดุบูู ุงูุงุฎุชุจุงุฑุงุช ุจุชุฑุชูุจ ุนุดูุงุฆู
```bash
pip install pytest-random-order
```

ููู: ุณูุคุฏู ูุฌูุฏ pytest-random-order ุฅูู ุฌุนู ุงูุงุฎุชุจุงุฑุงุช ุนุดูุงุฆูุฉ ุชููุงุฆููุงุ ุฏูู ุงูุญุงุฌุฉ ุฅูู ุฅุฌุฑุงุก ุฃู ุชุบููุฑุงุช ูู ุงูุชูููู ุฃู ุฎูุงุฑุงุช ุณุทุฑ ุงูุฃูุงูุฑ.

ููุง ูู ููุถุญ ุณุงุจููุงุ ูุณูุญ ูุฐุง ุจุงูุชุดุงู ุงูุงุฎุชุจุงุฑุงุช ุงูููุชุฑูุฉ - ุญูุซ ุชุคุซุฑ ุญุงูุฉ ุฃุญุฏ ุงูุงุฎุชุจุงุฑุงุช ุนูู ุญุงูุฉ ุงุฎุชุจุงุฑ ุขุฎุฑ. ุนูุฏูุง ูุชู ุชุซุจูุช pytest-random-orderุ ูุฅูู ุณูุทุจุน ุงูุจุฐุฑุฉ ุงูุนุดูุงุฆูุฉ ุงูุชู ุงุณุชุฎุฏููุง ูุชูู ุงูุฌูุณุฉุ ุนูู ุณุจูู ุงููุซุงู:

```bash
pytest tests
[...]
Using --random-order-bucket=module
Using --random-order-seed=573663
```

ุญุชู ุฃูู ุฅุฐุง ูุดูุช ุชุณูุณู ูุนููุ ูููููู ุฅุนุงุฏุฉ ุฅูุชุงุฌู ุนู ุทุฑูู ุฅุถุงูุฉ ุชูู ุงูุจุฐุฑุฉ ุงูุฏูููุฉุ ุนูู ุณุจูู ุงููุซุงู:

```bash
pytest --random-order-seed=573663
[...]
Using --random-order-bucket=module
Using --random-order-seed=573663
```

ุณูุคุฏู ุฐูู ุฅูู ุฅุนุงุฏุฉ ุฅูุชุงุฌ ุงูุชุฑุชูุจ ุงูุฏููู ููุท ุฅุฐุง ููุช ุชุณุชุฎุฏู ููุณ ูุงุฆูุฉ ุงูุงุฎุชุจุงุฑุงุช (ุฃู ุนุฏู ูุฌูุฏ ูุงุฆูุฉ ุนูู ุงูุฅุทูุงู). ูุจูุฌุฑุฏ ุฃู ุชุจุฏุฃ ูู ุชุถููู ูุงุฆูุฉ ุงูุงุฎุชุจุงุฑุงุช ูุฏูููุงุ ููู ุชุชููู ุจุนุฏ ุฐูู ูู ุงูุงุนุชูุงุฏ ุนูู ุงูุจุฐุฑุฉุ ูููู ูุฌุจ ุนููู ุฅุฏุฑุงุฌูุง ูุฏูููุง ุจุงูุชุฑุชูุจ ุงูุฏููู ุงูุฐู ูุดูุช ููู ูุฅุฎุจุงุฑ pytest ุจุนุฏู ุฌุนููุง ุนุดูุงุฆูุฉ ุจุฏูุงู ูู ุฐูู ุจุงุณุชุฎุฏุงู `--random-order-bucket=none`ุ ุนูู ุณุจูู ุงููุซุงู:

```bash
pytest --random-order-bucket=none tests/test_a.py tests/test_c.py tests/test_b.py
```

ูุฅููุงู ุงูุชุดููุด ูุฌููุน ุงูุงุฎุชุจุงุฑุงุช:

```bash
pytest --random-order-bucket=none
```

ุจุดูู ุงูุชุฑุงุถูุ ูุชู ุถููููุง ุงุณุชุฎุฏุงู `--random-order-bucket=module`ุ ูุงูุฐู ุณูููู ุจุฎูุท ุงููููุงุช ุนูู ูุณุชูู ุงููุญุฏุงุช ุงูููุทูุฉ. ูููููู ุฃูุถูุง ุงูุฎูุท ุนูู ูุณุชููุงุช "class" ู"package" ู"global" ู"none". ููุญุตูู ุนูู ุงูุชูุงุตูู ุงููุงููุฉุ ูุฑุฌู ุงูุงุทูุงุน ุนูู [ูุซุงุฆูู](https://github.com/jbasko/pytest-random-order).

ุจุฏูู ุขุฎุฑ ููุนุดูุงุฆูุฉ ูู: [`pytest-randomly`](https://github.com/pytest-dev/pytest-randomly). ููุฐู ุงููุญุฏุฉ ุงูููุทูุฉ ูุธุงุฆู/ูุงุฌูุฉ ูุดุงุจูุฉ ุฌุฏูุงุ ูููููุง ูุง ุชุญุชูู ุนูู ุฃูุถุงุน ุงูุฏูุงุก ุงููุชุงุญุฉ ูู pytest-random-order. ููุฏููุง ููุณ ุงููุดููุฉ ูู ูุฑุถ ููุณูุง ุจูุฌุฑุฏ ุชุซุจูุชูุง.

### ุงูุงุฎุชูุงูุงุช ูู ุงููุธูุฑ ูุงูุดุนูุฑ
#### pytest-sugar
[pytest-sugar](https://github.com/Frozenball/pytest-sugar) ูู ุฅุถุงูุฉ ุชุญุณู ุงููุธูุฑ ูุงูุดุนูุฑุ ูุชุถูู ุดุฑูุท ุชูุฏูุ ูุชุธูุฑ ุงูุงุฎุชุจุงุฑุงุช ุงูุชู ุชูุดู ูุงูุชุฃููุฏ ุนูู ุงูููุฑ. ูุชู ุชูุดูุทู ุชููุงุฆููุง ุนูุฏ ุงูุชุซุจูุช.

```bash
pip install pytest-sugar
```

ูุชุดุบูู ุงูุงุฎุชุจุงุฑุงุช ุจุฏูููุงุ ูู ุจุชุดุบูู:

```bash
pytest -p no:sugar
```

ุฃู ุฅูุบุงุก ุชุซุจูุชูุง.

#### ุงูุฅุจูุงุบ ุนู ุงุณู ูู ุงุฎุชุจุงุฑ ูุฑุนู ูุชูุฏูู
ูุงุฎุชุจุงุฑ ูุงุญุฏ ุฃู ูุฌููุนุฉ ูู ุงูุงุฎุชุจุงุฑุงุช ุนุจุฑ pytest (ุจุนุฏ pip install pytest-pspec):

```bash
pytest --pspec tests/test_optimization.py
```

#### ุฅุธูุงุฑ ุงูุงุฎุชุจุงุฑุงุช ุงููุงุดูุฉ ุนูู ุงูููุฑ
[pytest-instafail](https://github.com/pytest-dev/pytest-instafail) ุชุนุฑุถ ุญุงูุงุช ุงููุดู ูุงูุฃุฎุทุงุก ุนูู ุงูููุฑ ุจุฏูุงู ูู ุงูุงูุชุธุงุฑ ุญุชู ููุงูุฉ ุฌูุณุฉ ุงูุงุฎุชุจุงุฑ.

```bash
pip install pytest-instafail
```

```bash
pytest --instafail
```
## ุฅูู GPU ุฃู ุนุฏู ุงูุชูุฌู ุฅูู GPU

ุนูู ุฅุนุฏุงุฏ ููููู ูู GPUุ ูุงุฎุชุจุงุฑ ุงููุถุน ุงูุฎุงุต ุจู CPU ููุทุ ุฃุถู "CUDA_VISIBLE_DEVICES=":

```bash
CUDA_VISIBLE_DEVICES="" pytest tests/utils/test_logging.py
```

ุฃู ุฅุฐุง ูุงู ูุฏูู ุนุฏุฉ ูุญุฏุงุช GPUุ ูููููู ุชุญุฏูุฏ ุฃููุง ุณูุชู ุงุณุชุฎุฏุงูู ุจูุงุณุทุฉ "pytest". ุนูู ุณุจูู ุงููุซุงูุ ูุงุณุชุฎุฏุงู ูุญุฏุฉ GPU ุงูุซุงููุฉ ููุท ุฅุฐุง ูุงู ูุฏูู ูุญุฏุงุช GPU "0" ู"1"ุ ููููู ุชุดุบูู ูุง ููู:

```bash
CUDA_VISIBLE_DEVICES="1" pytest tests/utils/test_logging.py
```

ูุฐุง ูููุฏ ุนูุฏูุง ุชุฑูุฏ ุชุดุบูู ููุงู ูุฎุชููุฉ ุนูู ูุญุฏุงุช GPU ูุฎุชููุฉ.

ูุฌุจ ุชุดุบูู ุจุนุถ ุงูุงุฎุชุจุงุฑุงุช ุนูู ูุถุน CPU ููุทุ ุจูููุง ูููู ุชุดุบูู ุงุฎุชุจุงุฑุงุช ุฃุฎุฑู ุนูู CPU ุฃู GPU ุฃู TPUุ ูููุงู ุงุฎุชุจุงุฑุงุช ุฃุฎุฑู ูุฌุจ ุชุดุบูููุง ุนูู ูุญุฏุงุช GPU ูุชุนุฏุฏุฉ. ููุชู ุงุณุชุฎุฏุงู ุฒุฎุงุฑู ุงูุชุฎุทู ุงูุชุงููุฉ ูุชุญุฏูุฏ ูุชุทูุจุงุช ุงูุงุฎุชุจุงุฑุงุช ูููุง ูุชุนูู ุจู CPU/GPU/TPU:

- `require_torch` - ุณูุชู ุชุดุบูู ูุฐุง ุงูุงุฎุชุจุงุฑ ููุท ุชุญุช torch

- `require_torch_gpu` - ูุซู `require_torch` ุจุงูุฅุถุงูุฉ ุฅูู ุฃูู ูุชุทูุจ ูุญุฏุฉ GPU ูุงุญุฏุฉ ุนูู ุงูุฃูู

- `require_torch_multi_gpu` - ูุซู `require_torch` ุจุงูุฅุถุงูุฉ ุฅูู ุฃูู ูุชุทูุจ ูุญุฏุชู GPU ุนูู ุงูุฃูู

- `require_torch_non_multi_gpu` - ูุซู `require_torch` ุจุงูุฅุถุงูุฉ ุฅูู ุฃูู ูุชุทูุจ ุตูุฑ ุฃู ูุญุฏุฉ GPU ูุงุญุฏุฉ

- `require_torch_up_to_2_gpus` - ูุซู `require_torch` ุจุงูุฅุถุงูุฉ ุฅูู ุฃูู ูุชุทูุจ ุตูุฑ ุฃู ูุญุฏุฉ ุฃู ูุญุฏุชู GPU

- `require_torch_xla` - ูุซู `require_torch` ุจุงูุฅุถุงูุฉ ุฅูู ุฃูู ูุชุทูุจ ูุญุฏุฉ TPU ูุงุญุฏุฉ ุนูู ุงูุฃูู

ุฏุนููุง ููุถุญ ูุชุทูุจุงุช ูุญุฏุฉ GPU ูู ุงูุฌุฏูู ุงูุชุงูู:

| ุนุฏุฏ ูุญุฏุงุช GPU | ุงูุฒุฎุฑู                         |
|---------|----------------------------|
| >= 0   | `@require_torch`           |
| >= 1   | `@require_torch_gpu`       |
| >= 2   | `@require_torch_multi_gpu` |
| < 2    | `@require_torch_non_multi_gpu` |
| < 3    | `@require_torch_up_to_2_gpus`  |

ุนูู ุณุจูู ุงููุซุงูุ ุฅููู ุงุฎุชุจุงุฑ ูุฌุจ ุชุดุบููู ููุท ุนูุฏูุง ุชููู ููุงู ูุญุฏุชู GPU ุฃู ุฃูุซุฑ ูุชุงุญุชูู ูุชู ุชุซุจูุช pytorch:

```python no-style
@require_torch_multi_gpu
def test_example_with_multi_gpu():
```

ุฅุฐุง ุชุทูุจ ุงูุงุฎุชุจุงุฑ ูุฌูุฏ `tensorflow`ุ ููุฌุจ ุงุณุชุฎุฏุงู ุงูุฒุฎุฑู `require_tf`. ุนูู ุณุจูู ุงููุซุงู:

```python no-style
@require_tf
def test_tf_thing_with_tensorflow():
```

ูููู ุชูุฏูุณ ูุฐู ุงูุฒุฎุงุฑู ููู ุจุนุถูุง ุงูุจุนุถ. ุนูู ุณุจูู ุงููุซุงูุ ุฅุฐุง ูุงู ุงูุงุฎุชุจุงุฑ ุจุทูุฆูุง ููุชุทูุจ ูุญุฏุฉ GPU ูุงุญุฏุฉ ุนูู ุงูุฃูู ูู pytorchุ ูููููู ุฅุนุฏุงุฏู ุนูู ุงููุญู ุงูุชุงูู:

```python no-style
@require_torch_gpu
@slow
def test_example_slow_on_gpu():
```

ูููู ุจุนุถ ุงูุฒุฎุงุฑู ูุซู `@parametrized` ุจุฅุนุงุฏุฉ ูุชุงุจุฉ ุฃุณูุงุก ุงูุงุฎุชุจุงุฑุงุชุ ูุฐูู ูุฌุจ ุฅุฏุฑุงุฌ ุฒุฎุงุฑู ุงูุชุฎุทู `@require_*` ูู ุงูููุงูุฉ ููู ุชุนูู ุจุดูู ุตุญูุญ. ููููุง ููู ูุซุงู ุนูู ุงูุงุณุชุฎุฏุงู ุงูุตุญูุญ:

```python no-style
@parameterized.expand(...)
@require_torch_multi_gpu
def test_integration_foo():
```

ูุง ุชูุฌุฏ ูุฐู ุงููุดููุฉ ูู ุงูุชุฑุชูุจ ูุน `@pytest.mark.parametrize`ุ ูููููู ูุถุนู ุฃููุงู ุฃู ุขุฎุฑูุง ูุณูุธู ูุนูู. ููููู ูุนูู ููุท ูุน non-unittests.

ุฏุงุฎู ุงูุงุฎุชุจุงุฑุงุช:

- ุนุฏุฏ ูุญุฏุงุช GPU ุงููุชุงุญุฉ:

```python
from transformers.testing_utils import get_gpu_count

n_gpu = get_gpu_count() # ูุนูู ูุน torch ู tf
```

## ุงูุงุฎุชุจุงุฑ ุจุงุณุชุฎุฏุงู PyTorch ุฎูููุฉ ุฃู ุฌูุงุฒ ูุญุฏุฏ

ูุชุดุบูู ูุฌููุนุฉ ุงูุงุฎุชุจุงุฑุงุช ุนูู ุฌูุงุฒ PyTorch ูุญุฏุฏุ ุฃุถู `TRANSFORMERS_TEST_DEVICE="$device"` ุญูุซ `$device` ูู backend ุงููุณุชูุฏู. ุนูู ุณุจูู ุงููุซุงูุ ูุงุฎุชุจุงุฑ ูุถุน CPU ููุท:

```bash
TRANSFORMERS_TEST_DEVICE="cpu" pytest tests/utils/test_logging.py
```

ุชููู ูุฐู ุงููุชุบูุฑุงุช ูููุฏุฉ ูุงุฎุชุจุงุฑ backends PyTorch ูุฎุตุตุฉ ุฃู ุฃูู ุดููุนูุง ูุซู `mps` ุฃู `xpu` ุฃู `npu`. ููููู ุฃูุถูุง ุงุณุชุฎุฏุงููุง ูุชุญููู ููุณ ุชุฃุซูุฑ `CUDA_VISIBLE_DEVICES` ุนู ุทุฑูู ุงุณุชูุฏุงู ูุญุฏุงุช GPU ูุญุฏุฏุฉ ุฃู ุงูุงุฎุชุจุงุฑ ูู ูุถุน CPU ููุท.

ูุฏ ุชุชุทูุจ ุจุนุถ ุงูุฃุฌูุฒุฉ ุงุณุชูุฑุงุฏูุง ุฅุถุงูููุง ุจุนุฏ ุงุณุชูุฑุงุฏ `torch` ูููุฑุฉ ุงูุฃููู. ููููู ุชุญุฏูุฏ ูุฐุง ุจุงุณุชุฎุฏุงู ูุชุบูุฑ ุงูุจูุฆุฉ `TRANSFORMERS_TEST_BACKEND`:

```bash
TRANSFORMERS_TEST_BACKEND="torch_npu" pytest tests/utils/test_logging.py
```

ูุฏ ุชุชุทูุจ backends ุงูุจุฏููุฉ ุฃูุถูุง ุงุณุชุจุฏุงู ูุธุงุฆู ูุญุฏุฏุฉ ููุฌูุงุฒ. ุนูู ุณุจูู ุงููุซุงูุ ูุฏ ุชุญุชุงุฌ ุฅูู ุงุณุชุจุฏุงู `torch.cuda.manual_seed` ุจูุธููุฉ ุชุนููู ุงูุจุฐูุฑ ุงููุญุฏุฏุฉ ููุฌูุงุฒ ูุซู `torch.npu.manual_seed` ุฃู `torch.xpu.manual_seed` ูุชุนููู ุงูุจุฐูุฑ ุงูุนุดูุงุฆูุฉ ุจุดูู ุตุญูุญ ุนูู ุงูุฌูุงุฒ. ููุชุญุฏูุฏ backend ุฌุฏูุฏ ูุน ูุธุงุฆู ูุญุฏุฏุฉ ููุฌูุงุฒ ุนูุฏ ุชุดุบูู ูุฌููุนุฉ ุงูุงุฎุชุจุงุฑุงุชุ ูู ุจุฅูุดุงุก ููู ููุงุตูุงุช Python ุจุงุณู `spec.py` ุจุงูุชูุณูู ุงูุชุงูู:

```python
import torch
import torch_npu # ุจุงููุณุจุฉ ุฅูู xpuุ ุงุณุชุจุฏูู ุจู `import intel_extension_for_pytorch`
# !! ูููู ุฅุถุงูุฉ ุงุณุชูุฑุงุฏุงุช ุฅุถุงููุฉ ููุง !!

# ุชุญุฏูุฏ ุงุณู ุงูุฌูุงุฒ (ูุซู 'cuda' ุฃู 'cpu' ุฃู 'npu' ุฃู 'xpu' ุฃู 'mps')
DEVICE_NAME = 'npu'

# ุชุญุฏูุฏ backends ุงููุญุฏุฏุฉ ููุฌูุงุฒ ูุฅุฑุณุงููุง.
# ุฅุฐุง ูู ูุชู ุชุญุฏูุฏูุงุ ูุณูุชู ุงูุฑุฌูุน ุฅูู 'default' ูู 'testing_utils.py`
MANUAL_SEED_FN = torch.npu.manual_seed
EMPTY_CACHE_FN = torch.npu.empty_cache
DEVICE_COUNT_FN = torch.npu.device_count
```

ูุณูุญ ูุฐุง ุงูุชูุณูู ุฃูุถูุง ุจุชุญุฏูุฏ ุฃู ุงุณุชูุฑุงุฏุงุช ุฅุถุงููุฉ ูุทููุจุฉ. ูุงุณุชุฎุฏุงู ูุฐุง ุงูููู ูุงุณุชุจุฏุงู ุงูุทุฑู ุงูููุงูุฆุฉ ูู ูุฌููุนุฉ ุงูุงุฎุชุจุงุฑุงุชุ ูู ุจุชุนููู ูุชุบูุฑ ุงูุจูุฆุฉ `TRANSFORMERS_TEST_DEVICE_SPEC` ุฅูู ูุณุงุฑ ููู ุงูููุงุตูุงุชุ ุนูู ุณุจูู ุงููุซุงู `TRANSFORMERS_TEST_DEVICE_SPEC=spec.py`.

ุญุงูููุงุ ูุชู ุฏุนู `MANUAL_SEED_FN` ู`EMPTY_CACHE_FN` ู`DEVICE_COUNT_FN` ููุท ููุชูููุถ ุงููุญุฏุฏ ููุฌูุงุฒ.

## ุงูุชุฏุฑูุจ ุงูููุฒุน

ูุง ูููู ูู `pytest` ุงูุชุนุงูู ูุน ุงูุชุฏุฑูุจ ุงูููุฒุน ูุจุงุดุฑุฉู. ุฅุฐุง ุชู ูุญุงููุฉ ุฐูู - ูุฅู ุงูุนูููุงุช ุงููุฑุนูุฉ ูุง ุชููู ุจุงูุดูุก ุงูุตุญูุญ ูุชูุชูู ุจุงูุชูููุฑ ูู ุฃููุง `pytest` ูุชุจุฏุฃ ูู ุชุดุบูู ูุฌููุนุฉ ุงูุงุฎุชุจุงุฑุงุช ูู ุญููุงุช. ููููู ูุนูู ุฅุฐุง ูุงู ุฃุญุฏ ุจุชุดุบูู ุนูููุฉ ุนุงุฏูุฉ ุชููู ุจุนุฏ ุฐูู ุจุชุดุบูู ุงูุนุฏูุฏ ูู ุงูุนูุงู ูุฅุฏุงุฑุฉ ุฃูุงุจูุจ ุงูุฅุฏุฎุงู/ุงูุฅุฎุฑุงุฌ.

ููููุง ููู ุจุนุถ ุงูุงุฎุชุจุงุฑุงุช ุงูุชู ุชุณุชุฎุฏููุง:

- [test_trainer_distributed.py](https://github.com/huggingface/transformers/tree/main/tests/trainer/test_trainer_distributed.py)

- [test_deepspeed.py](https://github.com/huggingface/transformers/tree/main/tests/deepspeed/test_deepspeed.py)

ููุงูุชูุงู ูุจุงุดุฑุฉู ุฅูู ููุทุฉ ุงูุชูููุฐุ ุงุจุญุซ ุนู ููุงููุฉ `execute_subprocess_async` ูู ุชูู ุงูุงุฎุชุจุงุฑุงุช.

ุณุชุญุชุงุฌ ุฅูู ูุญุฏุชู GPU ุนูู ุงูุฃูู ููุดุงูุฏุฉ ูุฐู ุงูุงุฎุชุจุงุฑุงุช ุฃุซูุงุก ุงูุนูู:

```bash
CUDA_VISIBLE_DEVICES=0,1 RUN_SLOW=1 pytest -sv tests/test_trainer_distributed.py
```

## ุงูุชูุงุท ุงูุฅุฎุฑุงุฌ

ุฃุซูุงุก ุชูููุฐ ุงูุงุฎุชุจุงุฑุ ูุชู ุงูุชูุงุท ุฃู ุฅุฎุฑุงุฌ ูุชู ุฅุฑุณุงูู ุฅูู `stdout` ู`stderr`. ุฅุฐุง ูุดู ุฃุญุฏ ุงูุงุฎุชุจุงุฑุงุช ุฃู ุทุฑููุฉ ุงูุฅุนุฏุงุฏุ ูุณูุชู ุนุงุฏุฉู ุนุฑุถ ุงูุฅุฎุฑุงุฌ ุงูููุงุจู ุงูุฐู ุชู ุงูุชูุงุทู ุฌูุจูุง ุฅูู ุฌูุจ ูุน ุชุชุจุน ูุดู.

ูุฅููุงู ุงูุชูุงุท ุงูุฅุฎุฑุงุฌ ูุงูุญุตูู ุนูู `stdout` ู`stderr` ุจุดูู ุทุจูุนูุ ุงุณุชุฎุฏู `-s` ุฃู `--capture=no`:

```bash
pytest -s tests/utils/test_logging.py
```

ูุฅุฑุณุงู ูุชุงุฆุฌ ุงูุงุฎุชุจุงุฑ ุฅูู ุฅุฎุฑุงุฌ ุจุชูุณูู JUnit:

```bash
pytest tests --junitxml=result.xml
```

## ุงูุชุญูู ูู ุงูุฃููุงู

ูุนุฏู ุงุณุชุฎุฏุงู ุฃู ููู (ุนูู ุณุจูู ุงููุซุงูุ ุงูุฃุตูุฑ ุนูู ุฎูููุฉ ุจูุถุงุก ุบูุฑ ูุงุจู ูููุฑุงุกุฉ):

```bash
pytest --color=no tests/utils/test_logging.py
```

## ุฅุฑุณุงู ุชูุฑูุฑ ุงูุงุฎุชุจุงุฑ ุฅูู ุฎุฏูุฉ Pastebin ุนุจุฑ ุงูุฅูุชุฑูุช

ุฅูุดุงุก ุนููุงู URL ููู ูุดู ูู ุงูุงุฎุชุจุงุฑ:

```bash
pytest --pastebin=failed tests/utils/test_logging.py
```

ุณูููู ูุฐุง ุจุฅุฑุณุงู ูุนูููุงุช ุชุดุบูู ุงูุงุฎุชุจุงุฑ ุฅูู ุฎุฏูุฉ Paste ุนู ุจูุนุฏ ูุชูููุฑ ุนููุงู URL ููู ูุดู. ููููู ุงุฎุชูุงุฑ ุงูุงุฎุชุจุงุฑุงุช ูุงููุนุชุงุฏ ุฃู ุฅุถุงูุฉ -x ุฅุฐุง ููุช ุชุฑูุฏ ุฅุฑุณุงู ูุดู ูุงุญุฏ ููุท ุนูู ุณุจูู ุงููุซุงู.

ุฅูุดุงุก ุนููุงู URL ูุณุฌู ุฌูุณุฉ ุงูุงุฎุชุจุงุฑ ุจุงููุงูู:

```bash
pytest --pastebin=all tests/utils/test_logging.py
```

## ูุชุงุจุฉ ุงูุงุฎุชุจุงุฑุงุช

ุชุนุชูุฏ ุงุฎุชุจุงุฑุงุช ๐ค transformers ุนูู `unittest`ุ ูููู ูุชู ุชุดุบูููุง ุจูุงุณุทุฉ `pytest`ุ ูุฐูู ูููู ุงุณุชุฎุฏุงู ููุฒุงุช ููุง ุงููุธุงููู ูู ูุนุธู ุงูููุช.

ููููู ูุฑุงุกุฉ [ููุง](https://docs.pytest.org/en/stable/unittest.html) ุนู ุงูููุฒุงุช ุงููุฏุนููุฉุ ูููู ุงูุดูุก ุงูููู ุงูุฐู ูุฌุจ ุชุฐูุฑู ูู ุฃู ูุนุธู ูุคุดุฑุงุช `pytest` ูุง ุชุนูู. ููุง ูุชู ุฏุนู ุงููุนููุงุช ุฃูุถูุงุ ูููููุง ูุณุชุฎุฏู ุงููุญุฏุฉ ุงูููุทูุฉ `parameterized` ุงูุชู ุชุนูู ุจุทุฑููุฉ ูุดุงุจูุฉ.
### ุงููุนููุฉ 

ุบุงูุจูุง ูุง ุชููู ููุงู ุญุงุฌุฉ ูุชุดุบูู ููุณ ุงูุงุฎุชุจุงุฑ ุนุฏุฉ ูุฑุงุชุ ูููู ุจุงุณุชุฎุฏุงู ุญุฌุฌ ูุฎุชููุฉ. ูููู ุงูููุงู ุจุฐูู ูู ุฏุงุฎู ุงูุงุฎุชุจุงุฑุ ูููู ุจุนุฏ ุฐูู ูุง ุชูุฌุฏ ุทุฑููุฉ ูุชุดุบูู ูุฐุง ุงูุงุฎุชุจุงุฑ ููุฌููุนุฉ ูุงุญุฏุฉ ููุท ูู ุงูุญุฌุฌ. 

```python
# test_this1.py
import unittest
from parameterized import parameterized


class TestMathUnitTest(unittest.TestCase):
    @parameterized.expand(
    [
    ("negative", -1.5, -2.0),
    ("integer", 1, 1.0),
    ("large fraction", 1.6, 1),
    ]
    )
    def test_floor(self, name, input, expected):
    assert_equal(math.floor(input), expected)
``` 

ุงูุขูุ ุจุดูู ุงูุชุฑุงุถูุ ุณูุชู ุชุดุบูู ูุฐุง ุงูุงุฎุชุจุงุฑ 3 ูุฑุงุชุ ููู ูู ูุฑุฉ ูุชู ุชุนููู ุงูุญุฌุฌ ุงูุซูุงุซ ุงูุฃุฎูุฑุฉ ูู `test_floor` ุฅูู ุงูุญุฌุฌ ุงูููุงุจูุฉ ูู ูุงุฆูุฉ ุงููุนููุงุช. 

ูููููู ุชุดุบูู ูุฌููุนุงุช "negative" ู "integer" ููุท ูู ุงููุนููุงุช ุจุงุณุชุฎุฏุงู: 

```bash
pytest -k "negative and integer" tests/test_mytest.py
``` 

ุฃู ุฌููุน ุงููุฌููุนุงุช ุงููุฑุนูุฉ ุจุงุณุชุซูุงุก "negative" ุจุงุณุชุฎุฏุงู: 

```bash
pytest -k "not negative" tests/test_mytest.py
``` 

ุจุงูุฅุถุงูุฉ ุฅูู ุงุณุชุฎุฏุงู ุนุงูู ุชุตููุฉ `-k` ุงููุฐููุฑ ุฃุนูุงูุ ููููู ูุนุฑูุฉ ุงูุงุณู ุงูุฏููู ููู ุงุฎุชุจุงุฑ ูุฑุนู ูุชุดุบูู ุฃู ูููุง ุฃู ุฌููุนูุง ุจุงุณุชุฎุฏุงู ุฃุณูุงุฆูุง ุงูุฏูููุฉ. 

```bash
pytest test_this1.py --collect-only -q
``` 

ูุณูู ูุณุฑุฏ: 

```bash
test_this1.py::TestMathUnitTest::test_floor_0_negative
test_this1.py::TestMathUnitTest::test_floor_1_integer
test_this1.py::TestMathUnitTest::test_floor_2_large_fraction
``` 

ูุฐุง ุงูุขู ููููู ุชุดุบูู ุงุฎุชุจุงุฑูู ูุฑุนููู ูุญุฏุฏูู ููุท: 

```bash
pytest test_this1.py::TestMathUnitTest::test_floor_0_negative test_this1.py::TestMathUnitTest::test_floor_1_integer
``` 

ุชุชูุงูู ุงููุญุฏุฉ ุงูููุทูุฉ [parameterized](https://pypi.org/project/parameterized/)ุ ุงูููุฌูุฏุฉ ุจุงููุนู ูู ุชุจุนูุงุช ุงููุทูุฑ ูู `transformers`ุ ูุน ููุง ุงูููุนูู: `unittests` ู `pytest` tests. 

ููุน ุฐููุ ุฅุฐุง ูู ููู ุงูุงุฎุชุจุงุฑ ุนุจุงุฑุฉ ุนู `unittest`ุ ูููููู ุงุณุชุฎุฏุงู `pytest.mark.parametrize` (ุฃู ูุฏ ุชุฑู ุฃููุง ูุณุชุฎุฏูุฉ ูู ุจุนุถ ุงูุงุฎุชุจุงุฑุงุช ุงูููุฌูุฏุฉุ ุฎุงุตุฉู ุชุญุช `examples`). 

ููุง ููุณ ุงููุซุงูุ ูููู ูุฐู ุงููุฑุฉ ุจุงุณุชุฎุฏุงู ูุคุดุฑ `pytest` `parametrize`: 

```python
# test_this2.py
import pytest


@pytest.mark.parametrize(
"name, input, expected",
[
("negative", -1.5, -2.0),
("integer", 1, 1.0),
("large fraction", 1.6, 1),
],
)
def test_floor(name, input, expected):
assert_equal(math.floor(input), expected)
``` 

ูุซู `parameterized`ุ ููููู ุงูุชุญูู ุงูุฏููู ูู ุงูุงุฎุชุจุงุฑุงุช ุงููุฑุนูุฉ ุงูุชู ูุชู ุชุดุบูููุง ุจุงุณุชุฎุฏุงู `pytest.mark.parametrize` ุฅุฐุง ูู ุชูู ูุธููุฉ ุงูุชุตููุฉ `-k` ุจุงููููุฉ. ุจุงุณุชุซูุงุก ุฃู ุฏุงูุฉ ุงููุนููุฉ ูุฐู ุชููุดุฆ ูุฌููุนุฉ ูุฎุชููุฉ ููููุงู ูู ุงูุฃุณูุงุก ููุงุฎุชุจุงุฑุงุช ุงููุฑุนูุฉ. ูููุง ููู ููููุฉ ุธููุฑูุง: 

```bash
pytest test_this2.py --collect-only -q
``` 

ูุณูู ูุณุฑุฏ: 

```bash
test_this2.py::test_floor[integer-1-1.0]
test_this2.py::test_floor[negative--1.5--2.0]
test_this2.py::test_floor[large fraction-1.6-1]
``` 

ูุฐุง ุงูุขู ููููู ุชุดุบูู ุงูุงุฎุชุจุงุฑ ุงููุญุฏุฏ ููุท: 

```bash
pytest test_this2.py::test_floor[negative--1.5--2.0] test_this2.py::test_floor[integer-1-1.0]
``` 

ููุง ูู ุงููุซุงู ุงูุณุงุจู. 

### ุงููููุงุช ูุงููุฌูุฏุงุช 

ูู ุงูุงุฎุชุจุงุฑุงุชุ ูุญุชุงุฌ ุบุงูุจูุง ุฅูู ูุนุฑูุฉ ููุงู ูุฌูุฏ ุงูุฃุดูุงุก ุจุงููุณุจุฉ ูููู ุงูุงุฎุชุจุงุฑ ุงูุญุงููุ ููุฐุง ููุณ ุฃูุฑูุง ุจุณูุทูุง ูุฃู ุงูุงุฎุชุจุงุฑ ูุฏ ูุชู ุงุณุชุฏุนุงุคู ูู ุฃูุซุฑ ูู ุฏููู ุฃู ูุฏ ูููู ููุฌูุฏูุง ูู ูุฌูุฏุงุช ูุฑุนูุฉ ุจุฏุฑุฌุงุช ูุฎุชููุฉ. ุชููู ูุฆุฉ ุงููุณุงุนุฏุฉ `transformers.test_utils.TestCasePlus` ุจุญู ูุฐู ุงููุดููุฉ ุนู ุทุฑูู ูุฑุฒ ุฌููุน ุงููุณุงุฑุงุช ุงูุฃุณุงุณูุฉ ูุชูููุฑ ูุตูู ุณูู ุฅูููุง: 

- ูุงุฆูุงุช `pathlib` (ุฌููุนูุง ูุญุฏุฏุฉ ุจุงููุงูู): 

- `test_file_path` - ูุณุงุฑ ููู ุงูุงุฎุชุจุงุฑ ุงูุญุงููุ ุฃู `__file__`

- `test_file_dir` - ุงูุฏููู ุงูุฐู ูุญุชูู ุนูู ููู ุงูุงุฎุชุจุงุฑ ุงูุญุงูู 

- `tests_dir` - ุฏููู ูุฌููุนุฉ ุงุฎุชุจุงุฑุงุช `tests` 

- `examples_dir` - ุฏููู ูุฌููุนุฉ ุงุฎุชุจุงุฑุงุช `examples` 

- `repo_root_dir` - ุฏููู ูุณุชูุฏุน 

- `src_dir` - ุฏููู `src` (ุฃู ุญูุซ ููุฌุฏ ุงููุฌูุฏ ุงููุฑุนู `transformers`) 

- ุงููุณุงุฑุงุช ุงููุนุจุฑุฉ ูุณูุงุณู - ููุณ ูุง ุณุจู ูููู ูุฐู ุงูุฃุณุงููุจ ุชุนูุฏ ุงููุณุงุฑุงุช ูุณูุงุณูุ ุจุฏูุงู ูู ูุงุฆูุงุช `pathlib`: 

- `test_file_path_str` 

- `test_file_dir_str` 

- `tests_dir_str` 

- `examples_dir_str` 

- `repo_root_dir_str` 

- `src_dir_str` 

ูุจุฏุก ุงุณุชุฎุฏุงู ูุฐู ุงูุทุฑูุ ูู ูุง ุชุญุชุงุฌู ูู ุงูุชุฃูุฏ ูู ุฃู ุงูุงุฎุชุจุงุฑ ููุฌูุฏ ูู ูุฆุฉ ูุฑุนูุฉ ูู `transformers.test_utils.TestCasePlus`. ุนูู ุณุจูู ุงููุซุงู: 

```python
from transformers.testing_utils import TestCasePlus


class PathExampleTest(TestCasePlus):
def test_something_involving_local_locations(self):
data_dir = self.tests_dir / "fixtures/tests_samples/wmt_en_ro"
``` 

ุฅุฐุง ูู ุชูู ุจุญุงุฌุฉ ุฅูู ุงูุชุนุงูู ูุน ุงููุณุงุฑุงุช ุนุจุฑ `pathlib` ุฃู ุฅุฐุง ููุช ุจุญุงุฌุฉ ููุท ุฅูู ูุณุงุฑ ูุณูุณูุฉุ ูููููู ุฏุงุฆููุง ุงุณุชุฏุนุงุก `str()` ุนูู ูุงุฆู `pathlib` ุฃู ุงุณุชุฎุฏุงู ุงูุฃุณุงููุจ ุงูุชู ุชูุชูู ุจู `_str`. ุนูู ุณุจูู ุงููุซุงู: 

```python
from transformers.testing_utils import TestCasePlus


class PathExampleTest(TestCasePlus):
def test_something_involving_stringified_locations(self):
examples_dir = self.examples_dir_str
``` 

### ุงููููุงุช ูุงููุฌูุฏุงุช ุงููุคูุชุฉ 

ูุนุฏ ุงุณุชุฎุฏุงู ุงููููุงุช ูุงููุฌูุฏุงุช ุงููุคูุชุฉ ุงููุฑูุฏุฉ ุฃูุฑูุง ุถุฑูุฑููุง ูุชุดุบูู ุงูุงุฎุชุจุงุฑุงุช ุจุดูู ูุชูุงุฒูุ ุจุญูุซ ูุง ุชูุชุจ ุงูุงุฎุชุจุงุฑุงุช ููู ุจูุงูุงุช ุจุนุถูุง ุงูุจุนุถ. ููุง ูุฑูุฏ ุญุฐู ุงููููุงุช ูุงููุฌูุฏุงุช ุงููุคูุชุฉ ูู ููุงูุฉ ูู ุงุฎุชุจุงุฑ ูุงู ุจุฅูุดุงุฆูุง. ูุฐููุ ูู ุงูุถุฑูุฑู ุงุณุชุฎุฏุงู ุญุฒู ูุซู `tempfile`ุ ูุงูุชู ุชูุจู ูุฐู ุงูุงุญุชูุงุฌุงุช. 

ููุน ุฐููุ ุนูุฏ ุชุตุญูุญ ุฃุฎุทุงุก ุงูุงุฎุชุจุงุฑุงุชุ ุชุญุชุงุฌ ุฅูู ุงููุฏุฑุฉ ุนูู ุฑุคูุฉ ูุง ูุชู ุฅุฏุฎุงูู ูู ุงูููู ุฃู ุงูุฏููู ุงููุคูุช ูุชุฑูุฏ ูุนุฑูุฉ ูุณุงุฑู ุงูุฏููู ูุนุฏู ุฌุนูู ุนุดูุงุฆููุง ูู ูู ูุฑุฉ ูุชู ูููุง ุฅุนุงุฏุฉ ุชุดุบูู ุงูุงุฎุชุจุงุฑ. 

ุชุนุฏ ูุฆุฉ ุงููุณุงุนุฏุฉ `transformers.test_utils.TestCasePlus` ุฃูุถู ููุงุณุชุฎุฏุงู ูู ูุซู ูุฐู ุงูุฃุบุฑุงุถ. ุฅููุง ูุฆุฉ ูุฑุนูุฉ ูู `unittest.TestCase`ุ ูุฐูู ูููููุง ุจุณูููุฉ ุฃู ูุฑุซ ูููุง ูู ูุญุฏุงุช ุงูุงุฎุชุจุงุฑ. 

ููุง ูุซุงู ุนูู ุงุณุชุฎุฏุงููุง: 

```python
from transformers.testing_utils import TestCasePlus


class ExamplesTests(TestCasePlus):
def test_whatever(self):
tmp_dir = self.get_auto_remove_tmp_dir()
``` 

ููุดุฆ ูุฐุง ุงูููุฏ ุฏููููุง ูุคูุชูุง ูุฑูุฏูุงุ ููุญุฏุฏ `tmp_dir` ุฅูู ูููุนู. 

- ุฅูุดุงุก ุฏููู ูุคูุช ูุฑูุฏ: 

```python
def test_whatever(self):
tmp_dir = self.get_auto_remove_tmp_dir()
``` 

ุณูุญุชูู `tmp_dir` ุนูู ุงููุณุงุฑ ุฅูู ุงูุฏููู ุงููุคูุช ุงูุฐู ุชู ุฅูุดุงุคู. ุณูุชู ุฅุฒุงูุชู ุชููุงุฆููุง ูู ููุงูุฉ ุงูุงุฎุชุจุงุฑ. 

- ุฅูุดุงุก ุฏููู ูุคูุช ูู ุงุฎุชูุงุฑูุ ูุงูุชุฃูุฏ ูู ุฃูู ูุงุฑุบ ูุจู ุจุฏุก ุงูุงุฎุชุจุงุฑ ูุนุฏู ุฅูุฑุงุบู ุจุนุฏ ุงูุงุฎุชุจุงุฑ. 

```python
def test_whatever(self):
tmp_dir = self.get_auto_remove_tmp_dir("./xxx")
``` 

ูุฐุง ูููุฏ ููุชุตุญูุญ ุนูุฏูุง ุชุฑูุฏ ูุฑุงูุจุฉ ุฏููู ูุญุฏุฏ ูุชุฑูุฏ ุงูุชุฃูุฏ ูู ุฃู ุงูุงุฎุชุจุงุฑุงุช ุงูุณุงุจูุฉ ูู ุชุชุฑู ุฃู ุจูุงูุงุช ููุงู. 

- ููููู ุชุฌุงูุฒ ุงูุณููู ุงูุงูุชุฑุงุถู ุนู ุทุฑูู ุชุฌุงูุฒ ูุณูุทู `before` ู `after` ูุจุงุดุฑุฉูุ ููุง ูุคุฏู ุฅูู ุฃุญุฏ ุงูุณููููุงุช ุงูุชุงููุฉ: 

- `before=True`: ุณูุชู ุฏุงุฆููุง ูุณุญ ุงูุฏููู ุงููุคูุช ูู ุจุฏุงูุฉ ุงูุงุฎุชุจุงุฑ. 

- `before=False`: ุฅุฐุง ูุงู ุงูุฏููู ุงููุคูุช ููุฌูุฏูุง ุจุงููุนูุ ูุณุชุจูู ุฃู ูููุงุช ููุฌูุฏุฉ ููู. 

- `after=True`: ุณูุชู ุฏุงุฆููุง ุญุฐู ุงูุฏููู ุงููุคูุช ูู ููุงูุฉ ุงูุงุฎุชุจุงุฑ. 

- `after=False`: ุณูุชู ุฏุงุฆููุง ุชุฑู ุงูุฏููู ุงููุคูุช ุฏูู ุชุบููุฑ ูู ููุงูุฉ ุงูุงุฎุชุจุงุฑ. 

<Tip> 

ูุชุดุบูู ูุง ูุนุงุฏู `rm -r` ุจุฃูุงูุ ูุง ููุณูุญ ุฅูุง ุจุงูุฏูุงุฆู ุงููุฑุนูุฉ ููุณุชุฎุฑุฌ ูุณุชูุฏุน ุงููุดุฑูุน ุฅุฐุง ุชู ุงุณุชุฎุฏุงู `tmp_dir` ุตุฑูุญุ ุจุญูุซ ูุง ูุชู ุนู ุทุฑูู ุงูุฎุทุฃ ูุณุญ ุฃู ุฌุฒุก ููู ูู ูุธุงู ุงููููุงุช ูุซู `/tmp` ุฃู ูุง ุดุงุจู ุฐูู. ูุฑุฌู ุฏุงุฆููุง ุชูุฑูุฑ ุงููุณุงุฑุงุช ุงูุชู ุชุจุฏุฃ ุจู `./`. 

</Tip> 

<Tip> 

ูููู ููู ุงุฎุชุจุงุฑ ุชุณุฌูู ุนุฏุฉ ูุฌูุฏุงุช ูุคูุชุฉ ูุณูุชู ุฅุฒุงูุชูุง ุฌููุนูุง ุชููุงุฆููุงุ ูุง ูู ููุทูุจ ุฎูุงู ุฐูู. 

</Tip> 

### ุงูุชุบูุจ ุงููุคูุช ุนูู sys.path 

ุฅุฐุง ููุช ุจุญุงุฌุฉ ุฅูู ุชุฌุงูุฒ `sys.path` ูุคูุชูุง ูุงุณุชูุฑุงุฏ ุงุฎุชุจุงุฑ ุขุฎุฑุ ุนูู ุณุจูู ุงููุซุงูุ ูููููู ุงุณุชุฎุฏุงู ูุฏูุฑ ุงูุณูุงู `ExtendSysPath`. ูุซุงู: 

```python
import os
from transformers.testing_utils import ExtendSysPath

bindir = os.path.abspath(os.path.dirname(__file__))
with ExtendSysPath(f"{bindir}/.."):
from test_trainer import TrainerIntegrationCommon  # noqa
```
### ุชุฌุงูุฒ ุงูุงุฎุชุจุงุฑุงุช

ูุฐุง ูููุฏ ุนูุฏูุง ูุชู ุงูุชุดุงู ุฎุทุฃ ููุชู ูุชุงุจุฉ ุงุฎุชุจุงุฑ ุฌุฏูุฏุ ูููู ูู ูุชู ุฅุตูุงุญ ุงูุฎุทุฃ ุจุนุฏ. ุญุชู ูุชููู ูู ุงูุงูุชุฒุงู ุจู ูู ุงููุณุชูุฏุน ุงูุฑุฆูุณูุ ูุฌุจ ุฃู ูุชุฃูุฏ ูู ุฃูู ุชู ุชุฎุทูู ุฃุซูุงุก `make test`.

ุงูุทุฑู:

-  **ุชุฌุงูุฒ** ูุนูู ุฃูู ุชุชููุน ุฃู ููุฑ ุงุฎุชุจุงุฑู ููุท ุฅุฐุง ุชู ุงุณุชููุงุก ุจุนุถ ุงูุดุฑูุทุ ูุฅูุง ูุฌุจ ุนูู pytest ุฃู ูุชุฌุงูุฒ ุชุดุบูู ุงูุงุฎุชุจุงุฑ ุจุงููุงูู. ููู ุงูุฃูุซูุฉ ุงูุดุงุฆุนุฉ ุนูู ุฐูู ุชุฌุงูุฒ ุงูุงุฎุชุจุงุฑุงุช ุงูุฎุงุตุฉ ุจูุธุงู Windows ููุท ุนูู ููุตุงุช ุบูุฑ Windowsุ ุฃู ุชุฌุงูุฒ ุงูุงุฎุชุจุงุฑุงุช ุงูุชู ุชุนุชูุฏ ุนูู ููุฑุฏ ุฎุงุฑุฌู ุบูุฑ ูุชููุฑ ูู ุงูููุช ุงูุญุงูู (ูุซู ูุงุนุฏุฉ ุจูุงูุงุช).

-  **xfail** ูุนูู ุฃูู ุชุชููุน ูุดู ุงูุงุฎุชุจุงุฑ ูุณุจุจ ูุง. ููู ุงูุฃูุซูุฉ ุงูุดุงุฆุนุฉ ุนูู ุฐูู ุงุฎุชุจุงุฑ ููุฒุฉ ูู ูุชู ุชูููุฐูุง ุจุนุฏุ ุฃู ุฎุทุฃ ูู ูุชู ุฅุตูุงุญู ุจุนุฏ. ุนูุฏูุง ููุฌุญ ุงูุงุฎุชุจุงุฑ ุนูู ุงูุฑุบู ูู ุชููุน ูุดูู (ุชูุช ุชุณููุชู ุจู pytest.mark.xfail)ุ ููู xpass ูุณูุชู ุงูุฅุจูุงุบ ุนูู ูู ููุฎุต ุงูุงุฎุชุจุงุฑ.

ุฃุญุฏ ุงูุงุฎุชูุงูุงุช ุงููููุฉ ุจูู ุงูุงุซููู ูู ุฃู `skip` ูุง ูุดุบู ุงูุงุฎุชุจุงุฑุ ู`xfail` ููุนู ุฐูู. ูุฐุง ุฅุฐุง ูุงู ุงูููุฏ ุงููุนูุจ ูุชุณุจุจ ูู ุญุงูุฉ ุณูุฆุฉ ุณุชุคุซุฑ ุนูู ุงูุงุฎุชุจุงุฑุงุช ุงูุฃุฎุฑูุ ููุง ุชุณุชุฎุฏู `xfail`.

#### ุงูุชูููุฐ

-  ุฅููู ููููุฉ ุชุฎุทู ุงุฎุชุจุงุฑ ูุงูู ุฏูู ุดุฑูุท:

```python no-style
@unittest.skip(reason="this bug needs to be fixed")
def test_feature_x():
```

ุฃู ุนุจุฑ pytest:

```python no-style
@pytest.mark.skip(reason="this bug needs to be fixed")
```

ุฃู ุจุทุฑููุฉ `xfail`:

```python no-style
@pytest.mark.xfail
def test_feature_x():
```

ูููุง ููู ููููุฉ ุชุฎุทู ุงุฎุชุจุงุฑ ุจูุงุกู ุนูู ูุญูุตุงุช ุฏุงุฎููุฉ ุฏุงุฎู ุงูุงุฎุชุจุงุฑ:

```python
def test_feature_x():
if not has_something():
pytest.skip("unsupported configuration")
```

ุฃู ุงููุญุฏุฉ ุงูููุทูุฉ ุจุฃููููุง:

```python
import pytest

if not pytest.config.getoption("--custom-flag"):
pytest.skip("--custom-flag is missing, skipping tests", allow_module_level=True)
```

ุฃู ุจุทุฑููุฉ `xfail`:

```python
def test_feature_x():
pytest.xfail("expected to fail until bug XYZ is fixed")
```

-  ูููุง ููู ููููุฉ ุชุฎุทู ุฌููุน ุงูุงุฎุชุจุงุฑุงุช ูู ูุญุฏุฉ ููุทูุฉ ุฅุฐุง ูุงู ููุงู ุงุณุชูุฑุงุฏ ููููุฏ:

```python
docutils = pytest.importorskip("docutils", minversion="0.3")
```

-  ุชุฎุทู ุงุฎุชุจุงุฑ ุจูุงุกู ุนูู ุดุฑุท:

```python no-style
@pytest.mark.skipif(sys.version_info < (3,6), reason="requires python3.6 or higher")
def test_feature_x():
```

ุฃู:

```python no-style
@unittest.skipIf(torch_device == "cpu", "Can't do half precision")
def test_feature_x():
```

ุฃู ุชุฎุทู ุงููุญุฏุฉ ุงูููุทูุฉ ุจุฃููููุง:

```python no-style
@pytest.mark.skipif(sys.platform == 'win32', reason="does not run on windows")
class TestClass():
def test_feature_x(self):
```

ููุฒูุฏ ูู ุงูุชูุงุตูู ูุงูุฃูุซูุฉ ูุงูุทุฑูุ ุฑุงุฌุน [ููุง](https://docs.pytest.org/en/latest/skipping.html).

### ุงูุงุฎุชุจุงุฑุงุช ุงูุจุทูุฆุฉ

ููุชุจุฉ ุงูุงุฎุชุจุงุฑุงุช ุชุชุฒุงูุฏ ุจุงุณุชูุฑุงุฑุ ููุณุชุบุฑู ุจุนุถ ุงูุงุฎุชุจุงุฑุงุช ุฏูุงุฆู ููุชุดุบููุ ูุฐูู ูุง ูููููุง ุชุญูู ุงูุงูุชุธุงุฑ ููุฏุฉ ุณุงุนุฉ ุญุชู ุชูุชูู ูุฌููุนุฉ ุงูุงุฎุชุจุงุฑุงุช ุนูู CI. ูุฐููุ ูุน ุจุนุถ ุงูุงุณุชุซูุงุกุงุช ููุงุฎุชุจุงุฑุงุช ุงูุฃุณุงุณูุฉุ ูุฌุจ ูุถุน ุนูุงูุฉ ุนูู ุงูุงุฎุชุจุงุฑุงุช ุงูุจุทูุฆุฉ ููุง ูู ููุถุญ ูู ุงููุซุงู ุฃุฏูุงู:

```python no-style
from transformers.testing_utils import slow
@slow
def test_integration_foo():
```

ุจูุฌุฑุฏ ูุถุน ุนูุงูุฉ ุนูู ุงูุงุฎุชุจุงุฑ ุนูู ุฃูู `@slow`ุ ูุชุดุบูู ูุฐู ุงูุงุฎุชุจุงุฑุงุชุ ูู ุจุชุนููู ูุชุบูุฑ ุงูุจูุฆุฉ `RUN_SLOW=1`ุ ุนูู ุณุจูู ุงููุซุงู:

```bash
RUN_SLOW=1 pytest tests
```

ูููู ุจุนุถ ุงูุฏูููุฑุงุช ูุซู `@parameterized` ุจุฅุนุงุฏุฉ ูุชุงุจุฉ ุฃุณูุงุก ุงูุงุฎุชุจุงุฑุงุชุ ูุฐูู ูุฌุจ ุฅุฏุฑุงุฌ `@slow` ูุจููุฉ ุงูุฏูููุฑุงุช `@require_*` ูู ุงูููุงูุฉ ุญุชู ุชุนูู ุจุดูู ุตุญูุญ. ูููุง ููู ูุซุงู ุนูู ุงูุงุณุชุฎุฏุงู ุงูุตุญูุญ:

```python no-style
@parameterized.expand(...)
@slow
def test_integration_foo():
```

ููุง ูู ููุถุญ ูู ุจุฏุงูุฉ ูุฐู ุงููุซููุฉุ ูุชู ุชุดุบูู ุงูุงุฎุชุจุงุฑุงุช ุงูุจุทูุฆุฉ ููููุง ูุฌุฏูู ุฒูููุ ุจุฏูุงู ูู ูุญูุตุงุช CI ูู PRs. ูุฐูู ูู ุงููููู ุฃู ูุชู ุชูููุช ุจุนุถ ุงููุดููุงุช ุฃุซูุงุก ุชูุฏูู ุทูุจ ุณุญุจ ูุณูุชู ุฏูุฌูุง. ุณูุชู ุงูุชุดุงู ูุฐู ุงููุดููุงุช ุฃุซูุงุก ูููุฉ CI ุงููุฌุฏููุฉ ุงูุชุงููุฉ. ูููู ูุฐุง ูุนูู ุฃูุถูุง ุฃูู ูู ุงูููู ุชุดุบูู ุงูุงุฎุชุจุงุฑุงุช ุงูุจุทูุฆุฉ ุนูู ุฌูุงุฒู ูุจู ุชูุฏูู ุทูุจ ุงูุณุญุจ.

ูููุง ููู ุขููุฉ ุตูุน ุงููุฑุงุฑ ูุงุฎุชูุงุฑ ุงูุงุฎุชุจุงุฑุงุช ุงูุชู ูุฌุจ ูุถุน ุนูุงูุฉ ุนูููุง ุนูู ุฃููุง ุจุทูุฆุฉ:

ุฅุฐุง ูุงู ุงูุงุฎุชุจุงุฑ ูุฑูุฒ ุนูู ุฃุญุฏ ุงูููููุงุช ุงูุฏุงุฎููุฉ ููููุชุจุฉ (ุนูู ุณุจูู ุงููุซุงูุ ูููุงุช ุงูููุฐุฌุฉุ ุฃู ูููุงุช ุงูุชูููุฒุ ุฃู ุงูุฃูุงุจูุจ)ุ ููุฌุจ ุนูููุง ุชุดุบูู ูุฐุง ุงูุงุฎุชุจุงุฑ ูู ูุฌููุนุฉ ุงูุงุฎุชุจุงุฑุงุช ุบูุฑ ุงูุจุทูุฆุฉ. ุฅุฐุง ูุงู ูุฑูุฒ ุนูู ุฌุงูุจ ุขุฎุฑ ูู ุฌูุงูุจ ุงูููุชุจุฉุ ูุซู ุงููุซุงุฆู ุฃู ุงูุฃูุซูุฉุ ููุฌุจ ุนูููุง ุชุดุบูู ูุฐู ุงูุงุฎุชุจุงุฑุงุช ูู ูุฌููุนุฉ ุงูุงุฎุชุจุงุฑุงุช ุงูุจุทูุฆุฉ. ูุจุนุฏ ุฐููุ ูุชูููุญ ูุฐุง ุงูููุฌุ ูุฌุจ ุฃู ุชููู ูุฏููุง ุงุณุชุซูุงุกุงุช:

-  ูุฌุจ ูุถุน ุนูุงูุฉ ุนูู ุฌููุน ุงูุงุฎุชุจุงุฑุงุช ุงูุชู ุชุญุชุงุฌ ุฅูู ุชูุฒูู ูุฌููุนุฉ ูุจูุฑุฉ ูู ุงูุฃูุฒุงู ุฃู ูุฌููุนุฉ ุจูุงูุงุช ุฃูุจุฑ ูู ~50 ููุฌุงุจุงูุช (ุนูู ุณุจูู ุงููุซุงูุ ุงุฎุชุจุงุฑุงุช ุชูุงูู ุงูููุงุฐุฌ ุฃู ุงููุญูู ุงููุบูู ุฃู ุงูุฃูุงุจูุจ) ุนูู ุฃููุง ุจุทูุฆุฉ. ุฅุฐุง ููุช ุชููู ุจุฅุถุงูุฉ ูููุฐุฌ ุฌุฏูุฏุ ููุฌุจ ุนููู ุฅูุดุงุก ูุชุญููู ุฅุตุฏุงุฑ ูุตุบุฑ ููู (ุจุฃูุฒุงู ุนุดูุงุฆูุฉ) ูุงุฎุชุจุงุฑุงุช ุงูุชูุงูู. ูุชู ููุงูุดุฉ ุฐูู ูู ุงูููุฑุงุช ุงูุชุงููุฉ.

-  ูุฌุจ ูุถุน ุนูุงูุฉ ุนูู ุฌููุน ุงูุงุฎุชุจุงุฑุงุช ุงูุชู ุชุญุชุงุฌ ุฅูู ุฅุฌุฑุงุก ุชุฏุฑูุจ ุบูุฑ ููุณุชููุฏู ุจุดูู ุฎุงุต ููููู ุณุฑูุนูุง ุนูู ุฃููุง ุจุทูุฆุฉ.

-  ูููููุง ุชูุฏูู ุงุณุชุซูุงุกุงุช ุฅุฐุง ูุงูุช ุจุนุถ ูุฐู ุงูุงุฎุชุจุงุฑุงุช ุงูุชู ูุฌุจ ุฃูุง ุชููู ุจุทูุฆุฉ ุจุทูุฆุฉ ููุบุงูุฉุ ููุถุน ุนูุงูุฉ ุนูููุง ุนูู ุฃููุง `@slow`. ุชุนุฏ ุงุฎุชุจุงุฑุงุช ุงูููุฐุฌุฉ ุงูุชููุงุฆูุฉุ ุงูุชู ุชููู ุจุญูุธ ูุชุญููู ูููุงุช ูุจูุฑุฉ ุนูู ุงููุฑุตุ ูุซุงููุง ุฌูุฏูุง ุนูู ุงูุงุฎุชุจุงุฑุงุช ุงูุชู ุชู ูุถุน ุนูุงูุฉ ุนูููุง ุนูู ุฃููุง `@slow`.

-  ุฅุฐุง ุงูุชูู ุงูุงุฎุชุจุงุฑ ูู ุฃูู ูู ุซุงููุฉ ูุงุญุฏุฉ ุนูู CI (ุจูุง ูู ุฐูู ุนูููุงุช ุงูุชูุฒูู ุฅู ูุฌุฏุช)ุ ููุฌุจ ุฃู ูููู ุงุฎุชุจุงุฑูุง ุทุจูุนููุง ุจุบุถ ุงููุธุฑ ุนู ุฐูู.

ุจุดูู ุฌูุงุนูุ ูุฌุจ ุฃู ุชุบุทู ุฌููุน ุงูุงุฎุชุจุงุฑุงุช ุบูุฑ ุงูุจุทูุฆุฉ ุงูููููุงุช ุงูุฏุงุฎููุฉ ุงููุฎุชููุฉ ุจุงููุงููุ ูุน ุงูุญูุงุธ ุนูู ุณุฑุนุชูุง. ุนูู ุณุจูู ุงููุซุงูุ ูููู ุชุญููู ุชุบุทูุฉ ูุจูุฑุฉ ูู ุฎูุงู ุงูุงุฎุชุจุงุฑ ุจุงุณุชุฎุฏุงู ููุงุฐุฌ ูุตุบุฑุฉ ุชู ุฅูุดุงุคูุง ุฎุตูุตูุง ุจุฃูุฒุงู ุนุดูุงุฆูุฉ. ุชุญุชูู ูุฐู ุงูููุงุฐุฌ ุนูู ุงูุญุฏ ุงูุฃุฏูู ูู ุนุฏุฏ ุงูุทุจูุงุช (ุนูู ุณุจูู ุงููุซุงูุ 2)ุ ูุญุฌู ุงูููุฑุฏุงุช (ุนูู ุณุจูู ุงููุซุงูุ 1000)ุ ููุง ุฅูู ุฐูู. ุจุนุฏ ุฐููุ ูููู ูุงุฎุชุจุงุฑุงุช `@slow` ุงุณุชุฎุฏุงู ููุงุฐุฌ ูุจูุฑุฉ ูุจุทูุฆุฉ ูุฅุฌุฑุงุก ุงุฎุชุจุงุฑุงุช ููุนูุฉ. ููุดุงูุฏุฉ ุงุณุชุฎุฏุงู ูุฐูุ ูุง ุนููู ุณูู ุงูุจุญุซ ุนู ุงูููุงุฐุฌ *tiny* ุจุงุณุชุฎุฏุงู:

```bash
grep tiny tests examples
```

ูููุง ููู ูุซุงู ุนูู [script](https://github.com/huggingface/transformers/tree/main/scripts/fsmt/fsmt-make-tiny-model.py) ุงูุฐู ุฃูุดุฃ ุงููููุฐุฌ ุงููุตุบุฑ [stas/tiny-wmt19-en-de](https://huggingface.co/stas/tiny-wmt19-en-de). ููููู ุถุจุทู ุจุณูููุฉ ุนูู ุงูููุฏุณุฉ ุงููุนูุงุฑูุฉ ุงููุญุฏุฏุฉ ููููุฐุฌู.

ูู ุงูุณูู ููุงุณ ููุช ุงูุชุดุบูู ุจุดูู ุบูุฑ ุตุญูุญ ุฅุฐุง ูุงู ููุงูุ ุนูู ุณุจูู ุงููุซุงูุ ุฅุดุฑุงู ุนูู ุชูุฒูู ูููุฐุฌ ุถุฎูุ ูููู ุฅุฐุง ููุช ุจุงุฎุชุจุงุฑู ูุญูููุงุ ูุณูุชู ุชุฎุฒูู ุงููููุงุช ุงูุชู ุชู ุชูุฒูููุง ูุคูุชูุง ูุจุงูุชุงูู ูู ูุชู ููุงุณ ููุช ุงูุชูุฒูู. ูุฐููุ ุชุญูู ูู ุชูุฑูุฑ ุณุฑุนุฉ ุงูุชูููุฐ ูู ุณุฌูุงุช CI ุจุฏูุงู ูู ุฐูู (ุฅุฎุฑุงุฌ `pytest --durations=0 tests`).

ูุฐุง ุงูุชูุฑูุฑ ูููุฏ ุฃูุถูุง ููุนุซูุฑ ุนูู ุงูููู ุงูุดุงุฐุฉ ุงูุจุทูุฆุฉ ุงูุชู ูู ูุชู ูุถุน ุนูุงูุฉ ุนูููุง ุนูู ูุฐุง ุงููุญูุ ุฃู ุงูุชู ุชุญุชุงุฌ ุฅูู ุฅุนุงุฏุฉ ูุชุงุจุชูุง ูุชููู ุณุฑูุนุฉ. ุฅุฐุง ูุงุญุธุช ุฃู ูุฌููุนุฉ ุงูุงุฎุชุจุงุฑุงุช ุจุฏุฃุช ุชุตุจุญ ุจุทูุฆุฉ ุนูู CIุ ูุณูุธูุฑ ุฃุนูู ูุงุฆูุฉ ุจูุฐุง ุงูุชูุฑูุฑ ุฃุจุทุฃ ุงูุงุฎุชุจุงุฑุงุช.
## ุงุฎุชุจุงุฑ ุฅุฎุฑุงุฌ stdout/stderr

ูุงุฎุชุจุงุฑ ุงูุฏูุงู ุงูุชู ุชูุชุจ ูู stdout ู/ุฃู stderrุ ูููู ููุงุฎุชุจุงุฑ ุงููุตูู ุฅูู ูุฐู ุงูุชุฏููุงุช ุจุงุณุชุฎุฏุงู ูุธุงู capsys ูู pytest ููุง ููู:

```python
import sys


def print_to_stdout(s):
    print(s)


def print_to_stderr(s):
    sys.stderr.write(s)


def test_result_and_stdout(capsys):
    msg = "Hello"
    print_to_stdout(msg)
    print_to_stderr(msg)
    out, err = capsys.readouterr()  # ุงุณุชููุงู ุชุฏููุงุช ุงูุฅุฎุฑุงุฌ ุงูุชู ุชู ุงูุชูุงุทูุง
    # ุงุฎุชูุงุฑู: ุฅุฐุง ููุช ุชุฑูุฏ ุฅุนุงุฏุฉ ุชุดุบูู ุงูุชุฏููุงุช ุงูุชู ุชู ุงุณุชููุงููุง:
    sys.stdout.write(out)
    sys.stderr.write(err)
    # ุงูุงุฎุชุจุงุฑ:
    assert msg in out
    assert msg in err
```

ูุจุงูุทุจุนุ ูู ูุนุธู ุงูุฃุญูุงูุ ุณุชุฃุชู stderr ูุฌุฒุก ูู ุงุณุชุซูุงุกุ ูุฐูู ูุฌุจ ุงุณุชุฎุฏุงู try/except ูู ูุฐู ุงูุญุงูุฉ:

```python
def raise_exception(msg):
    raise ValueError(msg)


def test_something_exception():
    msg = "Not a good value"
    error = ""
    try:
        raise_exception(msg)
    except Exception as e:
        error = str(e)
    assert msg in error, f"{msg} ููุฌูุฏ ูู ุงูุงุณุชุซูุงุก:\n{error}"
```

ููุงู ุทุฑููุฉ ุฃุฎุฑู ูุงูุชูุงุท stdout ููู ุนุจุฑ contextlib.redirect_stdout:

```python
from io import StringIO
from contextlib import redirect_stdout


def print_to_stdout(s):
    print(s)


def test_result_and_stdout():
    msg = "Hello"
    buffer = StringIO()
    with redirect_stdout(buffer):
        print_to_stdout(msg)
    out = buffer.getvalue()
    # ุงุฎุชูุงุฑู: ุฅุฐุง ููุช ุชุฑูุฏ ุฅุนุงุฏุฉ ุชุดุบูู ุงูุชุฏููุงุช ุงูุชู ุชู ุงุณุชููุงููุง:
    sys.stdout.write(out)
    # ุงูุงุฎุชุจุงุฑ:
    assert msg in out
```

ููุงู ูุดููุฉ ูุญุชููุฉ ูููุฉ ุนูุฏ ุงูุชูุงุท stdout ููู ุฃููุง ูุฏ ุชุญุชูู ุนูู ุฃุญุฑู \r ุงูุชู ุชููู ูู ุนูููุฉ ุงูุทุจุงุนุฉ ุงูุนุงุฏูุฉ ุจุฅุนุงุฏุฉ ุชุนููู ูู ูุง ุชู ุทุจุงุนุชู ุญุชู ุงูุขู. ูุง ุชูุฌุฏ ูุดููุฉ ูุน pytestุ ูููู ูุน pytest -sุ ูุชู ุชุถููู ูุฐู ุงูุฃุญุฑู ูู ุงููุฎุฒู ุงููุคูุชุ ูุฐูู ููู ุชุชููู ูู ุชุดุบูู ุงูุงุฎุชุจุงุฑ ูุน ุฃู ุจุฏูู -sุ ูุฌุจ ุนููู ุฅุฌุฑุงุก ุชูุธูู ุฅุถุงูู ููุฅุฎุฑุงุฌ ุงูุฐู ุชู ุงูุชูุงุทู ุจุงุณุชุฎุฏุงู re.sub(r'~.*\r', '', buf, 0, re.M).

ูููู ุจุนุฏ ุฐููุ ูุฏููุง ูุณุงุนุฏ ุณูุงู wrapper ููุชุนุงูู ูุน ูู ุฐูู ุชููุงุฆููุงุ ุจุบุถ ุงููุธุฑ ุนูุง ุฅุฐุง ูุงู ูุญุชูู ุนูู ุฃุญุฑู \r ุฃู ูุงุ ูุฐูู ููู ุจุจุณุงุทุฉ:

```python
from transformers.testing_utils import CaptureStdout

with CaptureStdout() as cs:
    function_that_writes_to_stdout()
print(cs.out)
```

ููุง ูุซุงู ุงุฎุชุจุงุฑ ูุงูู:

```python
from transformers.testing_utils import CaptureStdout

msg = "Secret message\r"
final = "Hello World"
with CaptureStdout() as cs:
    print(msg + final)
assert cs.out == final + "\n", f"captured: {cs.out}, expecting {final}"
```

ุฅุฐุง ููุช ุชุฑูุฏ ุงูุชูุงุท stderrุ ุงุณุชุฎุฏู ูุฆุฉ CaptureStderr ุจุฏูุงู ูู ุฐูู:

```python
from transformers.testing_utils import CaptureStderr

with CaptureStderr() as cs:
    function_that_writes_to_stderr()
print(cs.err)
```

ุฅุฐุง ููุช ุจุญุงุฌุฉ ุฅูู ุงูุชูุงุท ููุง ุงูุชุฏูููู ูู ููุณ ุงูููุชุ ุงุณุชุฎุฏู ูุฆุฉ CaptureStd ุงูุฃุณุงุณูุฉ:

```python
from transformers.testing_utils import CaptureStd

with CaptureStd() as cs:
    function_that_writes_to_stdout_and_stderr()
print(cs.err, cs.out)
```

ุฃูุถูุงุ ูููุณุงุนุฏุฉ ูู ุชุตุญูุญ ูุดููุงุช ุงูุงุฎุชุจุงุฑุ ุชููู ูุฏูุฑู ุงูุณูุงู ูุคูุงุก ุจุดูู ุงูุชุฑุงุถู ุจุฅุนุงุฏุฉ ุชุดุบูู ุงูุชุฏููุงุช ุงูุชู ุชู ุงูุชูุงุทูุง ุชููุงุฆููุง ุนูุฏ ุงูุฎุฑูุฌ ูู ุงูุณูุงู.

## ุงูุชูุงุท ุชุฏูู ุณุฌู

ุฅุฐุง ููุช ุจุญุงุฌุฉ ุฅูู ุงูุชุญูู ูู ุฅุฎุฑุงุฌ ุณุฌู ูุนููุ ูููููู ุงุณุชุฎุฏุงู CaptureLogger:

```python
from transformers import logging
from transformers.testing_utils import CaptureLogger

msg = "Testing 1, 2, 3"
logging.set_verbosity_info()
logger = logging.get_logger("transformers.models.bart.tokenization_bart")
with CaptureLogger(logger) as cl:
    logger.info(msg)
assert cl.out, msg + "\n"
```

## ุงูุงุฎุชุจุงุฑ ุจุงุณุชุฎุฏุงู ูุชุบูุฑุงุช ุงูุจูุฆุฉ

ุฅุฐุง ููุช ุชุฑูุฏ ุงุฎุชุจุงุฑ ุชุฃุซูุฑ ูุชุบูุฑุงุช ุงูุจูุฆุฉ ูุงุฎุชุจุงุฑ ูุนููุ ูููููู ุงุณุชุฎุฏุงู ุงูุฏูููุฑ ุงููุณุงุนุฏ mockenv ูู transformers.testing_utils:

```python
from transformers.testing_utils import mockenv


class HfArgumentParserTest(unittest.TestCase):
    @mockenv(TRANSFORMERS_VERBOSITY="error")
    def test_env_override(self):
        env_level_str = os.getenv("TRANSFORMERS_VERBOSITY", None)
```

ูู ุจุนุถ ุงูุฃุญูุงูุ ูุญุชุงุฌ ุจุฑูุงูุฌ ุฎุงุฑุฌู ุฅูู ุงูุงุณุชุฏุนุงุกุ ูุงูุฐู ูุชุทูุจ ุถุจุท PYTHONPATH ูู os.environ ูุชุถููู ูุณุงุฑุงุช ูุญููุฉ ูุชุนุฏุฏุฉ. ูููุง ุชุฃุชู ูุฆุฉ ุงููุณุงุนุฏุฉ TestCasePlus ูู transformers.test_utils ูููุณุงุนุฏุฉ:

```python
from transformers.testing_utils import TestCasePlus


class EnvExampleTest(TestCasePlus):
    def test_external_prog(self):
        env = self.get_env()
        # ุงูุขู ูู ุจุงุณุชุฏุนุงุก ุงูุจุฑูุงูุฌ ุงูุฎุงุฑุฌูุ ููุฑุฑ ุฅููู env
```

ุงุนุชูุงุฏูุง ุนูู ูุง ุฅุฐุง ูุงู ููู ุงูุงุฎุชุจุงุฑ ููุฌูุฏูุง ูู ูุฌููุนุฉ ุงุฎุชุจุงุฑุงุช tests ุฃู examplesุ ูุณูููู ุจุฅุนุฏุงุฏ env[PYTHONPATH] ุจุดูู ุตุญูุญ ูุชุถููู ุฃุญุฏ ูุฐูู ุงูุฏูููููุ ููุฐูู ุฏููู src ูุถูุงู ุฅุฌุฑุงุก ุงูุงุฎุชุจุงุฑ ุนูู ุงููุณุชูุฏุน ุงูุญุงููุ ูุฃุฎูุฑูุง ูุน ุฃู env[PYTHONPATH] ุงูุฐู ุชู ุถุจุทู ุจุงููุนู ูุจู ุงุณุชุฏุนุงุก ุงูุงุฎุชุจุงุฑ ุฅุฐุง ูุงู ููุงู ุฃู ุดูุก.

ุชููุดุฆ ุทุฑููุฉ ุงููุณุงุนุฏุฉ ูุฐู ูุณุฎุฉ ูู ูุงุฆู os.environุ ูุฐูู ูุธู ุงููุงุฆู ุงูุฃุตูู ุณููููุง.

## ุงูุญุตูู ุนูู ูุชุงุฆุฌ ูุงุจูุฉ ููุชูุฑุงุฑ

ูู ุจุนุถ ุงูุญุงูุงุชุ ูุฏ ุชุฑุบุจ ูู ุฅุฒุงูุฉ ุงูุนุดูุงุฆูุฉ ูู ุงุฎุชุจุงุฑุงุชู. ููุญุตูู ุนูู ูุชุงุฆุฌ ูุชุทุงุจูุฉ ููุงุจูุฉ ููุชูุฑุงุฑุ ุณุชุญุชุงุฌ ุฅูู ุชุซุจูุช ุงูุจุฐุฑุฉ:

```python
seed = 42

# ูููุฏ ุงูุฃุฑูุงู ุงูุนุดูุงุฆูุฉ ูู ุจุงูุซูู
import random

random.seed(seed)

# ูููุฏุงุช ุงูุฃุฑูุงู ุงูุนุดูุงุฆูุฉ ูู ุจุงู ุชูุฑุด
import torch

torch.manual_seed(seed)
torch.backends.cudnn.deterministic = True
if torch.cuda.is_available():
    torch.cuda.manual_seed_all(seed)

# ูููุฏ ุงูุฃุฑูุงู ุงูุนุดูุงุฆูุฉ ูู ูููุจู
import numpy as np

np.random.seed(seed)

# ูููุฏ ุงูุฃุฑูุงู ุงูุนุดูุงุฆูุฉ ูู ุชูุณุฑููู
tf.random.set_seed(seed)
```

## ุชุตุญูุญ ุงูุงุฎุชุจุงุฑุงุช

ูุจุฏุก ูุตุญุญ ุงูุฃุฎุทุงุก ูู ููุทุฉ ุงูุชุญุฐูุฑุ ูู ุจูุง ููู:

```bash
pytest tests/utils/test_logging.py -W error::UserWarning --pdb
```

## ุงูุนูู ูุน ุณูุฑ ุนูู ุฅุฌุฑุงุกุงุช ุฌูุช ูุงุจ

ูุชุดุบูู ูููุฉ CI ุฐุงุชูุฉ ุงูุฏูุนุ ูุฌุจ ุนููู:

1. ุฅูุดุงุก ูุฑุน ุฌุฏูุฏ ุนูู ุฃุตู transformers (ููุณ ูุฑุนูุง!).
2. ูุฌุจ ุฃู ูุจุฏุฃ ุงุณู ุงููุฑุน ุจู ci_ ุฃู ci- (ูุคุฏู main ุฃูุถูุง ุฅูู ุชุดุบูููุ ูููู ูุง ูููููุง ุฅุฌุฑุงุก PRs ุนูู main). ูุชู ุชุดุบููู ุฃูุถูุง ููุท ููุณุงุฑุงุช ูุญุฏุฏุฉ - ููููู ุงูุนุซูุฑ ุนูู ุงูุชุนุฑูู ุงููุญุฏุซ ูู ุญุงูุฉ ุชุบููุฑู ููุฐ ูุชุงุจุฉ ูุฐู ุงููุซููุฉ [ููุง](https://github.com/huggingface/transformers/blob/main/.github/workflows/self-push.yml) ุชุญุช *ุฏูุน*.
3. ูู ุจุฅูุดุงุก ุทูุจ ุณุญุจ ูู ูุฐุง ุงููุฑุน.
4. ุจุนุฏ ุฐููุ ููููู ุฑุคูุฉ ุงููููุฉ ุชุธูุฑ [ููุง](https://github.com/huggingface/transformers/actions/workflows/self-push.yml). ูุฏ ูุง ูุชู ุชุดุบููู ุนูู ุงูููุฑ ุฅุฐุง ูุงู ููุงู ุชุฑุงูู.
## ุชุฌุฑุจุฉ ููุฒุงุช CI ุงูุชุฌุฑูุจูุฉ

ูููู ุฃู ุชููู ุชุฌุฑุจุฉ ููุฒุงุช CI ูุดููุฉ ูุญุชููุฉ ูุฃููุง ูุฏ ุชุชุนุงุฑุถ ูุน ุงูุชุดุบูู ุงูุทุจูุนู ูู CI. ูุฐููุ ุฅุฐุง ูุงู ูุฌุจ ุฅุถุงูุฉ ููุฒุฉ CI ุฌุฏูุฏุฉุ ููุฌุจ ุงูููุงู ุจุฐูู ุนูู ุงููุญู ุงูุชุงูู.

1. ูู ุจุฅูุดุงุก ูููุฉ ูุฎุตุตุฉ ุฌุฏูุฏุฉ ูุงุฎุชุจุงุฑ ูุง ูุญุชุงุฌ ุฅูู ุงุฎุชุจุงุฑ.
2. ูุฌุจ ุฃู ุชูุฌุญ ุงููููุฉ ุงูุฌุฏูุฏุฉ ุฏุงุฆููุง ุญุชู ุชุนุทููุง ุนูุงูุฉ โ ุฎุถุฑุงุก (ุงูุชูุงุตูู ุฃุฏูุงู).
3. ุงุชุฑููุง ุชุนูู ูุจุถุนุฉ ุฃูุงู ูุชุฑู ุฃู ูุฌููุนุฉ ูุชููุนุฉ ูู ุฃููุงุน ุทูุจุงุช ุงูุณุญุจ ูุชู ุชุดุบูููุง ุนูููุง (ูุฑูุน ูุณุชูุฏุน ุงููุณุชุฎุฏูุ ูุงููุฑูุน ุบูุฑ ุงููุชูุฑุนุฉุ ูุงููุฑูุน ุงูููุดุฃุฉ ูู ุฎูุงู ุชุญุฑูุฑ ููู ูุงุฌูุฉ ูุณุชุฎุฏู github.com ูุจุงุดุฑุฉุ ูุงูุฏูุนุงุช ุงููุณุฑูุฉ ุงููุฎุชููุฉุ ุฅูุฎ - ููุงู ุงููุซูุฑ) ุฃุซูุงุก ูุฑุงูุจุฉ ุณุฌูุงุช ุงููุธููุฉ ุงูุชุฌุฑูุจูุฉ (ููุณ ุงููุธููุฉ ุงููููุฉ ุฎุถุฑุงุก ูุฃูู ุฏุงุฆููุง ูุง ูููู ุฃุฎุถุฑูุง ุนู ูุตุฏ).
4. ุนูุฏูุง ูููู ูู ุงููุงุถุญ ุฃู ูู ุดูุก ุตูุจุ ูู ุจุฏูุฌ ุงูุชุบููุฑุงุช ุงูุฌุฏูุฏุฉ ูู ุงููุธุงุฆู ุงูููุฌูุฏุฉ.

ุจูุฐู ุงูุทุฑููุฉุ ูู ุชุชุนุงุฑุถ ุงูุชุฌุงุฑุจ ุนูู ูุธููุฉ CI ููุณูุง ูุน ุณูุฑ ุงูุนูู ุงูุนุงุฏู.

ูุงูุขูุ ููู ูููููุง ุฌุนู ุงููุธููุฉ ุชูุฌุญ ุฏุงุฆููุง ุฃุซูุงุก ุชุทููุฑ ููุฒุฉ CI ุงูุฌุฏูุฏุฉุ

ุชุฏุนู ุจุนุถ ุฃูุธูุฉ CIุ ูุซู TravisCI ignore-step-failure ูุณุชุจูุบ ุนู ูุฌุงุญ ุงููุธููุฉ ุจุดูู ุนุงูุ ูููู CircleCI ูGithub Actions ูุง ุชุฏุนูุงู ุฐูู ุงุนุชุจุงุฑูุง ูู ููุช ูุชุงุจุฉ ูุฐุง ุงูุชูุฑูุฑ.

ูุฐููุ ูููู ุงุณุชุฎุฏุงู ุงูุญู ุงูุจุฏูู ุงูุชุงูู:

1. `set +euo pipefail` ูู ุจุฏุงูุฉ ุฃูุฑ ุงูุชุดุบูู ูููุน ูุนุธู ุญุงูุงุช ุงููุดู ุงููุญุชููุฉ ูู ูุต Bash ุงูุจุฑูุฌู.
2. ูุฌุจ ุฃู ูููู ุงูุฃูุฑ ุงูุฃุฎูุฑ ูุงุฌุญูุง: `echo "done"` ุฃู ููุท `true` ุณููุนู ุฐูู

ูููุง ููู ูุซุงู:

```yaml
- run:
name: run CI experiment
command: |
set +euo pipefail
echo "setting run-all-despite-any-errors-mode"
this_command_will_fail
echo "but bash continues to run"
# emulate another failure
false
# but the last command must be a success
echo "during experiment do not remove: reporting success to CI, even if there were failures"
```

ุจุงููุณุจุฉ ููุฃูุงูุฑ ุงูุจุณูุทุฉุ ููููู ุฃูุถูุง ุงูููุงู ุจูุง ููู:

```bash
cmd_that_may_fail || true
```

ุจุงูุทุจุนุ ุจูุฌุฑุฏ ุงูุฑุถุง ุนู ุงููุชุงุฆุฌุ ูู ุจุฏูุฌ ุงูุฎุทูุฉ ุงูุชุฌุฑูุจูุฉ ุฃู ุงููุธููุฉ ูุน ุจููุฉ ุงููุธุงุฆู ุงูุนุงุฏูุฉุ ูุน ุฅุฒุงูุฉ `set +euo pipefail` ุฃู ุฃู ุฃุดูุงุก ุฃุฎุฑู ูุฏ ุชููู ุฃุถูุชูุง ูุถูุงู ุนุฏู ุชุฏุฎู ุงููุธููุฉ ุงูุชุฌุฑูุจูุฉ ูู ุงูุชุดุบูู ุงูุทุจูุนู ูู CI.

ูุงูุช ูุฐู ุงูุนูููุฉ ุจุฑูุชูุง ุณุชููู ุฃุณูู ุจูุซูุฑ ุฅุฐุง ูุงู ุจุฅููุงููุง ููุท ุชุนููู ุดูุก ูุซู `allow-failure` ููุฎุทูุฉ ุงูุชุฌุฑูุจูุฉุ ูุงูุณูุงุญ ููุง ุจุงููุดู ุฏูู ุงูุชุฃุซูุฑ ุนูู ุงูุญุงูุฉ ุงูุนุงูุฉ ูุทูุจุงุช ุงูุณุญุจ. ููููุ ููุง ุฐูุฑ ุณุงุจููุงุ ูุง ุชุฏุนู CircleCI ูGithub Actions ุฐูู ูู ุงูููุช ุงูุญุงูู.

ููููู ุงูุชุตููุช ุนูู ูุฐู ุงูููุฒุฉ ููุนุฑูุฉ ููุงููุง ูู ูุฐู ุงูููุงุถูุน ุงูุฎุงุตุฉ ุจู CI:

- [Github Actions:](https://github.com/actions/toolkit/issues/399)
- [CircleCI:](https://ideas.circleci.com/ideas/CCI-I-344)

## ุชูุงูู DeepSpeed

ุจุงููุณุจุฉ ูุทูุจ ุณุญุจ ูุชุถูู ุชูุงูู DeepSpeedุ ุถุน ูู ุงุนุชุจุงุฑู ุฃู ุฅุนุฏุงุฏ CI ุงูุฎุงุต ุจุทูุจุงุช ุณุญุจ CircleCI ูุง ูุญุชูู ุนูู ูุญุฏุงุช ูุนุงูุฌุฉ ุฑุณูููุฉ (GPU). ูุชู ุชุดุบูู ุงูุงุฎุชุจุงุฑุงุช ุงูุชู ุชุชุทูุจ ูุญุฏุงุช ูุนุงูุฌุฉ ุฑุณูููุฉ (GPU) ุนูู ูุธุงู ุชูุงูู ูุณุชูุฑ ูุฎุชูู ูููููุง. ููุฐุง ูุนูู ุฃูู ุฅุฐุง ุญุตูุช ุนูู ุชูุฑูุฑ CI ูุงุฌุญ ูู ุทูุจ ุงูุณุญุจ ุงูุฎุงุต ุจูุ ููุฐุง ูุง ูุนูู ุฃู ุงุฎุชุจุงุฑุงุช DeepSpeed ูุฏ ูุฌุญุช.

ูุชุดุบูู ุงุฎุชุจุงุฑุงุช DeepSpeed:

```bash
RUN_SLOW=1 pytest tests/deepspeed/test_deepspeed.py
```

ูุชุทูุจ ุฅุฌุฑุงุก ุฃู ุชุบููุฑุงุช ุนูู ุชุนูููุงุช ุจุฑูุฌุฉ ุงูููุงุฐุฌ ุฃู ุฃูุซูุฉ PyTorch ุชุดุบูู ุงุฎุชุจุงุฑุงุช ุญุฏููุฉ ุงูุญููุงูุงุช ุฃูุถูุง.

```bash
RUN_SLOW=1 pytest tests/deepspeed
```